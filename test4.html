<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>StreamingHub ‚Ä¢ Filmy (Supabase)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root { --bg:#0b0d10; --card:#151922; --text:#e3e7ee; --muted:#a1a9b8; --brand:#7e57c2; --border:#232a37; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1200px;margin:0 auto;padding:16px}
header{position:sticky;top:0;z-index:20;background:rgba(11,13,16,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.header-row{display:flex;align-items:center;gap:14px;padding:12px 16px}
.brand{font-weight:800;color:#fff;text-decoration:none}
.top-nav{margin-left:auto;display:flex;gap:16px}
.top-nav span{cursor:pointer;color:#cfd5e4}
.top-nav span:hover{color:#fff}
.search{width:320px;max-width:40vw;background:#0e1218;border:1px solid var(--border);color:#fff;padding:10px 12px;border-radius:12px}
.filters{display:grid;grid-template-columns:1.4fr 1fr 1fr 1fr;gap:10px;margin-top:12px}
select,input[type=number]{width:100%;padding:10px;background:#0e1218;border:1px solid var(--border);color:#fff;border-radius:10px}
.btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn.secondary{background:#2a3446}
.section{margin-top:22px}
.section h2{margin:0 0 10px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.card img{width:100%;height:260px;object-fit:cover;display:block}
.card .p{padding:10px}
.small{font-size:12px;color:var(--muted)}
.badge{font-size:12px;background:#2a3446;color:#fff;border-radius:999px;padding:2px 8px}
.row{display:flex;justify-content:space-between;align-items:center;gap:12px}
.alert{background:#152031;color:#cfe1ff;border:1px solid #1f2a40;padding:10px;border-radius:10px}
.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px}
.modal .box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;max-width:560px;width:100%}
.video{position:relative;width:100%;padding-bottom:56.25%;border-radius:18px;overflow:hidden;background:#000}
.video iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
.overlay{position:absolute;top:0;left:0;width:100%;height:25px;background:black;z-index:2}
hr{border:none;border-top:1px solid var(--border);margin:16px 0}
</style>
</head>
<body>
<header>
  <div class="header-row container">
    <a class="brand" href="#">üé¨ StreamingHub</a>
    <input id="q" class="search" type="search" placeholder="Szukaj film√≥w..." />
    <div class="top-nav">
      <span onclick="showPage('films')">Filmy</span>
      <span onclick="showPage('top10')">TOP 10</span>
      <span onclick="showPage('library')">Moja biblioteka</span>
      <span onclick="logout()">Wyloguj</span>
    </div>
  </div>
  <div class="container">
    <form id="filters" class="filters" onsubmit="event.preventDefault(); applyFilters()">
      <select id="f-category"><option value="">Kategoria</option></select>
      <input id="f-year" type="number" placeholder="Rok" />
      <input id="f-min" type="number" placeholder="Min. d≈Çugo≈õƒá (min)" />
      <select id="f-sort">
        <option value="rating">Sortuj: Ocena</option>
        <option value="new">Sortuj: Nowe</option>
        <option value="year">Sortuj: Rok</option>
        <option value="popular">Sortuj: Popularne</option>
      </select>
    </form>
  </div>
</header>

<main class="container">
  <!-- FILMY -->
  <section id="page-films" class="section">
    <h2>Polecane</h2>
    <div id="list-recommended" class="grid"></div>

    <div class="section">
      <h2>Nowo dodane</h2>
      <div id="list-new" class="grid"></div>
    </div>

    <div class="section">
      <div class="row">
        <h2>Najwy≈ºej oceniane</h2>
        <span class="small">na podstawie ≈õredniej z ocen</span>
      </div>
      <div id="list-top" class="grid"></div>
    </div>

    <hr />
    <h2>Wyniki filtrowania</h2>
    <div id="list-results" class="grid"></div>
  </section>

  <!-- TOP 10 (na podstawie ≈õredniej + popularno≈õci) -->
  <section id="page-top10" class="section hidden">
    <h2>üèÜ TOP 10</h2>
    <div id="list-top10" class="grid"></div>
  </section>

  <!-- Moja biblioteka (placeholder) -->
  <section id="page-library" class="section hidden">
    <h2>üìö Moja biblioteka</h2>
    <div class="alert">Ta sekcja bƒôdzie podpiƒôta p√≥≈∫niej (punkty/odblokowania).</div>
  </section>
</main>

<!-- modal szczeg√≥≈Çy filmu -->
<div id="movie-modal" class="modal" onclick="closeMovie(event)">
  <div class="box" onclick="event.stopPropagation()">
    <div id="movie-detail">≈Åadowanie‚Ä¶</div>
  </div>
</div>

<!-- modal admin: dodawanie filmu -->
<div id="admin-modal" class="modal" onclick="closeAdmin(event)">
  <div class="box" onclick="event.stopPropagation()">
    <h3>Dodaj film (Supabase ‚Üí movies)</h3>
    <form id="add-movie" onsubmit="event.preventDefault(); addMovie()">
      <div class="row" style="gap:10px">
        <input id="m-title" placeholder="Tytu≈Ç" style="flex:1" required />
        <input id="m-year" type="number" placeholder="Rok" style="width:140px">
      </div>
      <div class="row" style="gap:10px;margin-top:8px">
        <input id="m-duration" type="number" placeholder="D≈Çugo≈õƒá (min)" style="width:180px">
        <input id="m-points" type="number" placeholder="Punkty wymagane" style="width:200px">
      </div>
      <div style="margin-top:8px">
        <select id="m-category" required></select>
      </div>
      <div style="margin-top:8px">
        <input id="m-thumb" placeholder="Miniatura (URL)" required />
      </div>
      <div style="margin-top:8px">
        <input id="m-iframe" placeholder="iframe src (URL hostingu)" required />
      </div>
      <div style="margin-top:8px">
        <textarea id="m-desc" rows="4" placeholder="Opis"></textarea>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn">Dodaj</button>
        <button class="btn secondary" type="button" onclick="closeAdmin()">Anuluj</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ==== Supabase init ==== */
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ==== Router (3 ‚Äûpodstrony‚Äù) ==== */
function showPage(name){
  document.getElementById('page-films').classList.toggle('hidden', name!=='films');
  document.getElementById('page-top10').classList.toggle('hidden', name!=='top10');
  document.getElementById('page-library').classList.toggle('hidden', name!=='library');
}
function logout(){ /* pod auth p√≥≈∫niej */ alert('Wyloguj: do spiƒôcia z auth.'); }

/* ==== Utility ==== */
const $ = sel => document.querySelector(sel);
const esc = s => String(s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m]));

/* ==== ≈Åadowanie kategorii do filtr√≥w i modala ==== */
async function loadCategories(){
  const { data, error } = await db.from('categories').select('*').order('name', {ascending:true});
  const sel = $('#f-category'); const adminSel = $('#m-category');
  sel.innerHTML = '<option value="">Kategoria</option>' + (data||[]).map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join('');
  adminSel.innerHTML = (data||[]).map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join('');
}

/* ==== Pobranie film√≥w + pomocnicze agregaty ==== */
async function fetchAllMovies(){
  const { data, error } = await db.from('movies').select('*').order('created_at', {ascending:false});
  if(error){ console.error(error); return []; }
  return data||[];
}
async function fetchRatings(){
  const { data, error } = await db.from('ratings').select('movie_id, score');
  if(error){ console.error(error); return []; }
  return data||[];
}
async function fetchHistory(){
  const { data, error } = await db.from('history').select('movie_id');
  if(error){ console.error(error); return []; }
  return data||[];
}
function computeAverages(movies, ratings){
  const agg = new Map();
  for(const r of ratings){ const k=r.movie_id; if(!agg.has(k)) agg.set(k,[]); agg.get(k).push(r.score); }
  const avg = {};
  for(const m of movies){
    const list = agg.get(m.id)||[];
    avg[m.id] = list.length ? (list.reduce((a,b)=>a+b,0)/list.length) : null;
  }
  return avg;
}
function computePopularity(movies, history){
  const cnt = {};
  for(const h of history){ cnt[h.movie_id] = (cnt[h.movie_id]||0)+1; }
  const pop = {};
  for(const m of movies){ pop[m.id] = cnt[m.id]||0; }
  return pop;
}

/* ==== Render karty filmu ==== */
function card(m, avgMap, clickHandler='openMovie'){
  const avg = avgMap ? avgMap[m.id] : null;
  const rating = avg!=null ? avg.toFixed(1) : '-';
  return `
  <div class="card">
    <a href="#" onclick="${clickHandler}(${m.id});return false;">
      <img src="${esc(m.thumb)}" alt="${esc(m.title)}">
    </a>
    <div class="p">
      <div class="row">
        <strong><a href="#" onclick="${clickHandler}(${m.id});return false;">${esc(m.title)}</a></strong>
        <span class="badge">‚òÖ ${rating}</span>
      </div>
      <div class="small">czas: ${m.duration??'?'} min ‚Ä¢ rok: ${m.year??'?'}</div>
    </div>
  </div>`;
}

/* ==== Widok: strona g≈Ç√≥wna + top10 ==== */
async function loadHome(){
  const [movies, ratings, history] = await Promise.all([fetchAllMovies(), fetchRatings(), fetchHistory()]);
  const avg = computeAverages(movies, ratings);
  const pop = computePopularity(movies, history);

  // Polecane = najpopularniejsze
  const recommended = [...movies].sort((a,b)=> (pop[b.id] - pop[a.id])).slice(0,12);
  // Nowe ju≈º sƒÖ posortowane po created_at desc (fetchAllMovies)
  const newest = movies.slice(0,12);
  // Najwy≈ºej oceniane
  const top = [...movies].sort((a,b)=> ( (avg[b.id]||0) - (avg[a.id]||0) )).slice(0,12);

//  $('#list-recommended').innerHTML = recommended.map(m=>card(m, avg)).join('');
//  $('#list-new').innerHTML = newest.map(m=>card(m, avg)).join('');
//  $('#list-top').innerHTML = top.map(m=>card(m, avg)).join('');
//$('#list-filtered').innerHTML = '';


  // TOP10 (mix: 60% ocena, 40% popularno≈õƒá)
  const mixScore = m => ( (avg[m.id]||0)*0.6 + (pop[m.id]||0)*0.4 );
  const top10 = [...movies].sort((a,b)=> mixScore(b)-mixScore(a)).slice(0,10);
  $('#list-top10').innerHTML = top10.map(m=>card(m, avg)).join('');
}

/* ==== Filtrowanie/sortowanie + wyszukiwarka (g√≥ra strony) ==== */
async function applyFilters(){
  const q = $('#q').value.trim().toLowerCase();
  const cat = $('#f-category').value;
  const year = $('#f-year').value;
  const min = $('#f-min').value;
  const sort = $('#f-sort').value;

  const [movies, ratings, history] = await Promise.all([fetchAllMovies(), fetchRatings(), fetchHistory()]);
  const avg = computeAverages(movies, ratings);
  const pop = computePopularity(movies, history);

  let list = movies.filter(m => {
    if(q && !String(m.title||'').toLowerCase().includes(q)) return false;
    if(cat && String(m.category_id) !== String(cat)) return false;
    if(year && String(m.year) !== String(year)) return false;
    if(min && Number(m.duration||0) < Number(min)) return false;
    return true;
  });

  if(sort==='rating') list.sort((a,b)=> ( (avg[b.id]||0)-(avg[a.id]||0) ));
  if(sort==='new') list.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  if(sort==='year') list.sort((a,b)=> (b.year||0) - (a.year||0));
  if(sort==='popular') list.sort((a,b)=> ( (pop[b.id]||0) - (pop[a.id]||0) ));

  // üî• poka≈º tylko wyniki filtrowania
  $('#list-results').innerHTML = list.length 
    ? list.map(m=>card(m, avg)).join('') 
    : '<div class="alert">Brak wynik√≥w.</div>';

  // üî• wyczy≈õƒá stare sekcje
  $('#list-recommended').innerHTML = '';
  $('#list-new').innerHTML = '';
  $('#list-top').innerHTML = '';
}

/* ==== Szczeg√≥≈Çy filmu + odtwarzacz ==== */
async function openMovie(id){
  $('#movie-modal').style.display = 'flex';
  $('#movie-detail').innerHTML = '≈Åadowanie‚Ä¶';
  const { data: m, error } = await db.from('movies').select('*').eq('id', id).single();
  if(error || !m){ $('#movie-detail').innerHTML = '<div class="alert">Nie znaleziono filmu</div>'; return; }

  const content = `
    <div class="row">
      <h3 style="margin:0">${esc(m.title)}</h3>
      <button class="btn secondary" onclick="closeMovie()">Zamknij</button>
    </div>
    <div class="small" style="margin-top:4px">Rok: ${m.year??'?'} ‚Ä¢ D≈Çugo≈õƒá: ${m.duration??'?'} min ${m.points_required?`‚Ä¢ Wymagane punkty: ${m.points_required}`:''}</div>
    ${m.iframe ? `
      <div class="video" style="margin-top:12px">
        <iframe src="${esc(m.iframe)}" allowfullscreen></iframe>
        <div class="overlay"></div>
      </div>` :
      `<img src="${esc(m.thumb||'')}" style="width:100%;max-height:360px;object-fit:cover;border-radius:14px;margin-top:12px">`
    }
    <p style="margin-top:12px">${esc(m.description||'Brak opisu.')}</p>
    <div class="row" style="margin-top:8px">
      <a class="btn" href="${esc(m.iframe||'#')}" target="_blank">Otw√≥rz ≈∫r√≥d≈Ço</a>
    </div>
  `;
  $('#movie-detail').innerHTML = content;
}
function closeMovie(){ $('#movie-modal').style.display = 'none'; }

/* ==== Admin: dodawanie filmu ==== */
function toggleAdmin(){ const el = $('#admin-modal'); el.style.display = el.style.display==='flex' ? 'none' : 'flex'; }
function closeAdmin(){ $('#admin-modal').style.display='none'; }
async function addMovie(){
  const payload = {
    title: $('#m-title').value.trim(),
    description: $('#m-desc').value.trim(),
    iframe: $('#m-iframe').value.trim(),
    thumb: $('#m-thumb').value.trim(),
    category_id: Number($('#m-category').value),
    year: $('#m-year').value? Number($('#m-year').value) : null,
    duration: $('#m-duration').value? Number($('#m-duration').value) : null,
    points_required: $('#m-points').value? Number($('#m-points').value) : 0,
  };
  const { error } = await db.from('movies').insert(payload);
  if(error){ alert('B≈ÇƒÖd dodawania: '+error.message); return; }
  closeAdmin();
  await loadCategories();
  await loadHome();
  await applyFilters();
}

/* ==== Start ==== */
(async function init(){
  await loadCategories();
  await loadHome();
  await applyFilters();

  // szukaj po Enter
$('#q').addEventListener('input', applyFilters);
  // automatycznie filtruj, gdy zmieniasz pola
  ['f-category','f-year','f-min','f-sort'].forEach(id => {
    document.getElementById(id).addEventListener('change', applyFilters);
  });
})();
// üé¨ Pobieranie film√≥w z Supabase
async function loadMovies() {
  const { data: movies, error } = await db
    .from("movies")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("B≈ÇƒÖd film√≥w:", error);
    return;
  }

const { data: ratings, error: ratingsError } = await db
  .from("ratings")
  .select("movie_id, avg:score");

if (ratingsError) {
  console.error("B≈ÇƒÖd ocen:", ratingsError);
}


  let moviesWithRatings = movies.map(m => {
    const r = ratings ? ratings.find(r => r.movie_id === m.id) : null;
    return { ...m, avg_rating: r ? r.avg : 0 };
  });

  renderMovies("recommended", [...movies].sort((a,b)=>b.points_required - a.points_required).slice(0,5));
  renderMovies("new", movies.slice(0,5));
  renderMovies("toprated", moviesWithRatings.sort((a,b)=>b.avg_rating - a.avg_rating).slice(0,5));
}

// üöÄ Wywo≈Çaj przy starcie
loadMovies();

</script>
</body>
</html>
