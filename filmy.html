<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>StreamingHub ‚Äì Filmy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0f1115; --panel:#171923; --muted:#a6adc8; --accent:#7e57c2; --chip:#2a2f45; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#fff}
    header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;
      padding:12px 20px;background:#141620;border-bottom:1px solid #202334;position:sticky;top:0;z-index:10;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{font-weight:800;font-size:18px;letter-spacing:.2px}
    .search{
      flex:1;max-width:420px;display:flex;align-items:center;background:#11131b;border:1px solid #24283b;border-radius:10px;padding:8px 12px;
    }
    .search input{flex:1;border:none;background:transparent;color:#fff;outline:none}
    nav{display:flex;gap:18px;align-items:center}
    nav span{cursor:pointer;color:#e5e7eb;font-weight:600;opacity:.9}
    nav span:hover{color:var(--accent)}
    .btn{padding:8px 12px;border-radius:10px;background:#243b55;border:1px solid #2e405f;color:#fff;cursor:pointer}
    .container{padding:22px 32px}
    h2{margin:14px 0 12px 0;font-size:20px}
    .row{
      display:flex;gap:16px;overflow-x:auto;padding-bottom:8px;scrollbar-width:thin;scrollbar-color:#2b3047 transparent;
    }
    .card{
      min-width:190px;max-width:190px;background:var(--panel);border:1px solid #24283b;border-radius:14px;overflow:hidden;flex-shrink:0;cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .thumb{width:100%;height:270px;object-fit:cover;background:#0b0d14}
    .meta{padding:10px}
    .title{font-size:14px;font-weight:700;line-height:1.3;margin:0 0 6px}
    .sub{font-size:12px;color:var(--muted)}
    .chips{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #2d3452;border-radius:999px;padding:2px 8px;font-size:12px;color:#cbd5e1}
    .chip.ok{background:rgba(34,197,94,.1);border-color:#244c36;color:#9ae6b4}
    .chip.cost{background:rgba(126,87,194,.12);border-color:#3a2e57;color:#d6bcfa}
    .section{margin:24px 0}
    /* Search results box */
    #searchWrap{display:none;margin-top:10px}
    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
    }
    .modal{
      width:min(620px,100%);background:#141620;border:1px solid #262a40;border-radius:16px;overflow:hidden;
    }
    .modal header{background:#15182a;border-bottom:1px solid #232742}
    .modal .content{padding:18px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 18px;border-top:1px solid #232742;background:#121423}
    .btn.secondary{background:#1b2033;border-color:#313a5a}
    .alert{padding:10px 12px;border-radius:10px;background:#141a1a;border:1px solid #203636;color:#b7f0d1;margin-bottom:10px}
    .alert.err{background:#1d1416;border-color:#3f1c24;color:#fecaca}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">üé¨ StreamingHub</div>
      <div class="search">
        <input id="searchInput" placeholder="Szukaj film√≥w..." />
      </div>
    </div>
    <nav>
      <span onclick="showPage('filmy')">Filmy</span>
      <span onclick="showPage('top')">TOP 10</span>
      <span onclick="showPage('biblioteka')">Moja biblioteka</span>
      <span class="btn" onclick="logout()">Wyloguj</span>
    </nav>
  </header>

  <div class="container">
    <!-- Wyniki wyszukiwania -->
    <div id="searchWrap" class="section">
      <h2>Wyniki wyszukiwania</h2>
      <div id="searchResults" class="row"></div>
    </div>

    <!-- Filmy ‚Äì sekcje -->
    <div id="filmy" class="page active">
      <div class="section">
        <h2>Polecane</h2>
        <div id="recommended" class="row"></div>
      </div>

      <div class="section">
        <h2>Nowo dodane</h2>
        <div id="newest" class="row"></div>
      </div>

      <div class="section">
        <h2>Najwy≈ºej oceniane</h2>
        <div id="topRated" class="row"></div>
      </div>
    </div>

    <!-- TOP 10 (placeholder ‚Äì dzia≈Ça jak ‚ÄûNajwy≈ºej oceniane‚Äù) -->
    <div id="top" class="page" style="display:none">
      <div class="section">
        <h2>üèÜ TOP 10</h2>
        <div id="top10" class="row"></div>
      </div>
    </div>

    <!-- Moja biblioteka ‚Äì zrobimy, gdy bƒôdziesz got√≥w -->
    <div id="biblioteka" class="page" style="display:none">
      <div class="section">
        <h2>üìö Moja biblioteka (do zrobienia)</h2>
      </div>
    </div>
  </div>

  <!-- Modal zakupu/oglƒÖdania -->
  <div id="payModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <div class="logo">üé¨ StreamingHub</div>
      </header>
      <div class="content">
        <div id="payAlert"></div>
        <h3 id="payTitle" style="margin:0 0 6px"></h3>
        <div id="payMeta" style="color:#aab2cf;font-size:14px;margin-bottom:10px"></div>
        <div id="payCost" class="chips"></div>
        <p id="payDesc" style="color:#cbd5e1;margin-top:8px"></p>
      </div>
      <div class="actions">
        <button class="btn secondary" onclick="closeModal()">Anuluj</button>
        <button class="btn" id="payBtn" onclick="confirmPay()">Zap≈Çaƒá i oglƒÖdaj</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    //  SUPABASE ‚Äì konfiguracja
    // =========================
    const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";      // <- podmie≈Ñ
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";                     // <- podmie≈Ñ
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { autoRefreshToken: true, persistSession: true, detectSessionInUrl: true }
    });

    // Prosty "router" podstron
    function showPage(id){
      document.querySelectorAll(".page").forEach(p=>p.style.display="none");
      document.getElementById(id).style.display="block";
      if(id==="top") loadTop10();
    }

    async function logout(){
      await db.auth.signOut();
      window.location.href = "index.html";
    }

    // =========================
    //  Render kart filmu
    // =========================
    function card(movie){
      const div=document.createElement("div");
      div.className="card";
      div.onclick=()=> openPayModal(movie);
      div.innerHTML = `
        <img class="thumb" src="${movie.thumb || 'https://via.placeholder.com/190x270?text=Brak+miniatury'}" alt="${movie.title}">
        <div class="meta">
          <div class="title">${movie.title}</div>
          <div class="sub">czas: ${movie.duration ?? "?"} min ‚Ä¢ rok: ${movie.year ?? "?"}</div>
          <div class="chips">
            <span class="chip cost">üíé ${movie.points_required ?? 0} pkt</span>
            ${movie._views != null ? `<span class="chip">üëÅÔ∏è ${movie._views}</span>` : ""}
            ${movie._rating != null ? `<span class="chip ok">‚≠ê ${movie._rating.toFixed(1)}</span>` : ""}
          </div>
        </div>
      `;
      return div;
    }

    function renderList(containerId, movies){
      const el=document.getElementById(containerId);
      el.innerHTML="";
      movies.forEach(m=> el.appendChild(card(m)));
    }

    // =========================
    //  ≈Åadowanie sekcji
    // =========================
    async function loadAll(){
      await Promise.all([loadRecommended(), loadNewest(), loadTopRated()]);
    }

    // Polecane ‚Äì wg wy≈õwietle≈Ñ (watch_history)
    async function loadRecommended(limit=15){
      // Pr√≥ba przez RPC / widok
      let data=null, error=null;

      // 1) Je≈õli masz widok movie_stats (patrz SQL ni≈ºej)
      ({ data, error } = await db
        .from("movie_stats")
        .select("id,title,thumb,year,duration,points_required,views,avg_rating")
        .order("views", { ascending:false })
        .limit(limit)
      );
      if(!error && data?.length){
        data = data.map(m => ({...m, _views: m.views, _rating: m.avg_rating}));
        renderList("recommended", data);
        return;
      }

      // 2) Fallback: same filmy (gdy brak widoku/relacji)
      const res = await db.from("movies").select("*").order("created_at", {descending:true}).limit(limit);
      if(res.error){ console.error(res.error); return; }
      renderList("recommended", res.data);
    }

    // Nowo dodane ‚Äì po created_at
    async function loadNewest(limit=15){
      const { data, error } = await db
        .from("movies")
        .select("*")
        .order("created_at", { ascending:false })
        .limit(limit);
      if(error){ console.error(error); return; }
      renderList("newest", data);
    }

    // Najwy≈ºej oceniane ‚Äì ≈õrednia z ratings (RPC/widok), fallback do braku
    async function loadTopRated(limit=15){
      let { data, error } = await db
        .from("movie_stats")
        .select("id,title,thumb,year,duration,points_required,views,avg_rating")
        .order("avg_rating", { ascending:false })
        .limit(limit);
      if(!error && data?.length){
        data = data.map(m => ({...m, _views:m.views, _rating:m.avg_rating||0}));
        renderList("topRated", data);
        return;
      }
      // fallback: je≈õli nie ma ratings
      const fallback = await db.from("movies").select("*").order("created_at", {descending:true}).limit(limit);
      if(fallback.error){ console.error(fallback.error); return; }
      renderList("topRated", fallback.data);
    }

    // TOP 10 ‚Äì u≈ºyjemy tego samego co top rated
    async function loadTop10(){
      let { data, error } = await db
        .from("movie_stats")
        .select("id,title,thumb,year,duration,points_required,views,avg_rating")
        .order("avg_rating", { ascending:false })
        .limit(10);
      if(error){ console.error(error); return; }
      data = data.map(m => ({...m, _views:m.views, _rating:m.avg_rating||0}));
      renderList("top10", data);
    }

    // =========================
    //  Szukajka przy logo
    // =========================
    let searchTimer;
    document.getElementById("searchInput").addEventListener("input", e=>{
      clearTimeout(searchTimer);
      const q = e.target.value.trim();
      if(!q){
        document.getElementById("searchWrap").style.display="none";
        return;
      }
      searchTimer = setTimeout(()=> searchMovies(q), 250);
    });

    async function searchMovies(q){
      const { data, error } = await db
        .from("movies")
        .select("id,title,thumb,year,duration,points_required")
        .ilike("title", `%${q}%`)
        .limit(30);
      if(error){ console.error(error); return; }
      document.getElementById("searchWrap").style.display="block";
      renderList("searchResults", data);
    }

    // =========================
    //  Paywall (punkty)
    // =========================
    let selectedMovie = null;

    function openPayModal(movie){
      selectedMovie = movie;
      document.getElementById("payTitle").textContent = movie.title;
      document.getElementById("payMeta").textContent = `Rok: ${movie.year ?? "?"} ‚Ä¢ Czas: ${movie.duration ?? "?"} min`;
      document.getElementById("payDesc").textContent = movie.description || "";
      document.getElementById("payCost").innerHTML = `
        <span class="chip cost">üíé Wymagane: ${movie.points_required ?? 0} pkt</span>
      `;
      document.getElementById("payAlert").innerHTML = "";
      document.getElementById("payModal").style.display = "flex";
    }
    function closeModal(){
      document.getElementById("payModal").style.display = "none";
      selectedMovie = null;
    }

    async function confirmPay(){
      if(!selectedMovie) return;

      // 1) user & profile
      const { data: { user } } = await db.auth.getUser();
      if(!user){ window.location.href="index.html"; return; }

      const { data: profile, error: pErr } = await db
        .from("profiles")
        .select("points")
        .eq("id", user.id)
        .single();
      if(pErr){ console.error(pErr); showPayError("Nie uda≈Ço siƒô pobraƒá punkt√≥w."); return; }

      // 2) sprawd≈∫, czy ju≈º kupione (aby nie p≈Çaciƒá ponownie)
      const { data: already } = await db
        .from("purchases")
        .select("id")
        .eq("user_id", user.id)
        .eq("movie_id", selectedMovie.id)
        .maybeSingle();

      if(already){ // ju≈º ma dostƒôp ‚Äì oglƒÖdaj
        goWatch(selectedMovie.id);
        return;
      }

      const cost = Number(selectedMovie.points_required || 0);
      if((profile?.points ?? 0) < cost){
        showPayError(`Masz za ma≈Ço punkt√≥w. Dostƒôp kosztuje ${cost} pkt.`);
        return;
      }

      // 3) transakcja ‚Äì najpierw spr√≥buj RPC (atomowo)
      const rpc = await db.rpc("purchase_movie", { p_movie_id: selectedMovie.id });
      if(!rpc.error){
        goWatch(selectedMovie.id);
        return;
      }

      // 4) fallback (gdy nie masz RPC): dwa kroki
      // Uwaga: to nie jest w 100% atomowe ‚Äì polecam dodaƒá RPC z sekcji SQL poni≈ºej.
      const upd = await db
        .from("profiles")
        .update({ points: (profile.points - cost) })
        .eq("id", user.id)
        .select()
        .single();
      if(upd.error){ console.error(upd.error); showPayError("Nie uda≈Ço siƒô potrƒÖciƒá punkt√≥w."); return; }

      const ins = await db
        .from("purchases")
        .insert({ user_id: user.id, movie_id: selectedMovie.id, points_spent: cost })
        .select().single();
      if(ins.error){ console.error(ins.error); showPayError("Nie uda≈Ço siƒô zapisaƒá zakupu."); return; }

      goWatch(selectedMovie.id);
    }

    function showPayError(msg){
      document.getElementById("payAlert").innerHTML = `<div class="alert err">‚ùå ${msg}</div>`;
    }
    function goWatch(id){
      closeModal();
      window.location.href = `watch.html?id=${id}`;
    }

    // Start
    loadAll();
  </script>
</body>
</html>
