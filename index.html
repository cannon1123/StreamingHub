<html lang="pl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StreamingHub • Free video</title>
<style>
:root { --bg:#0b0d10; --card:#151922; --text:#e3e7ee; --muted:#a1a9b8; --brand:#4f7cff; --border:#232a37; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
a{color:var(--text);text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:rgba(11,13,16,.8);backdrop-filter:blur(6px);z-index:10}
.nav{display:flex;gap:12px;align-items:center;padding:12px 16px}
.brand{font-weight:800}
.nav input[type=search]{flex:1;background:#0e1218;border:1px solid var(--border);color:#fff;padding:10px 12px;border-radius:12px}
.menu a,.menu button{padding:8px 10px;color:var(--muted);background:none;border:none;cursor:pointer}
.btn{background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;border:none;cursor:pointer}
.btn.secondary{background:#2a3446}
.badge{font-size:12px;color:#fff;background:#2a3446;padding:2px 8px;border-radius:999px}
.grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.card.p{padding:12px}
.card img{width:100%;height:200px;object-fit:cover;display:block}
.small{font-size:12px;color:var(--muted)}
.section h2{margin:16px 0 8px}
.flex{display:flex;gap:12px;align-items:center}
.mt-2{margin-top:8px}.mt-4{margin-top:16px}.mt-8{margin-top:32px}
textarea, select, input[type=text], input[type=number], input[type=date], input[type=password]{width:100%;padding:10px;background:#0e1218;border:1px solid var(--border);color:#fff;border-radius:10px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
hr{border:none;border-top:1px solid var(--border);margin:16px 0}
table{width:100%;border-collapse:collapse} td,th{border-bottom:1px solid var(--border);padding:8px;text-align:left}
.player{width:100%;height:60vh;border:none;border-radius:22px}
.alert{background:#152031;padding:10px;border-radius:10px;color:#b7c4e6}
footer{color:var(--muted);text-align:center;padding:30px 0}
.hidden{display:none}
.tag{display:inline-block;margin:2px 4px;padding:4px 8px;border:1px solid var(--border);border-radius:999px}
.history-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 12px;
}

.history-item {
  background: var(--card);
  padding: 8px;
  border-radius: 10px;
  font-size: 14px;
  text-align: center;
}

/* 🔹 Responsywny odtwarzacz */
.video-container {
  position: relative;
  width: 100%;
  padding-bottom: 56.25%; /* 16:9 proporcja */
  height: 0;
  overflow: hidden;
  background: black;
}
.video-container iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: 0;
}
/* 🔹 Overlay do zakrycia górnego paska MEGA */
.overlay-block {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: black;
  z-index: 2;
}


/* 🔹 Pasek overlay 10px */
.top-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 25px;
  background: black;
  z-index: 999999;
}

/* 🔹 Napis StreamingHub w prawym górnym rogu */
.top-brand {
  position: fixed;
  top: 1px;
  right: 12px;
  font-size: 14px;
  font-weight: bold;
  color: white;
  z-index: 1000000;
}


/* Usunięcie białej kreski pod czasem i rokiem */
.card .small {
  border: none !important;
}
.card td, 
.card th, 
.card hr {
  border: none !important;
}
</style>

<style type="text/css" id="operaUserStyle"></style></head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="#" onclick="UI.show('home')">🎬 StreamingHub</a>
    <form onsubmit="event.preventDefault(); UI.search(this.q.value)" style="flex:1;">
      <input type="search" name="q" placeholder="Szukaj filmów...">
    </form>
    <nav class="menu flex">
      <a href="#" onclick="UI.show('home')">Filmy</a>
      <a href="#" onclick="UI.show('top')">TOP 10</a>
      <a href="#" onclick="UI.show('me')">Moja biblioteka</a>
      <a href="#" id="adminLink" class="" onclick="UI.show('admin')">Admin</a>
      <span id="authLinks" class="hidden">
        <a href="#" onclick="UI.show('login')">Zaloguj</a>
        <a href="#" onclick="UI.show('register')" class="btn">Rejestracja</a>
      </span>
      <form id="logoutForm" class="" onsubmit="event.preventDefault(); Auth.logout()">
        <button class="btn secondary">Wyloguj</button>
      </form>
    </nav>
  </div>
</header>

<main class="container" id="app">

  <!-- 🔹 NOWA SEKCJA: Historia oglądania -->
  <section class="section mt-8">
    <div class="flex" style="justify-content:space-between;">
      <h2>Historia oglądania</h2>
      <a href="#" id="toggleHistory" class="small">zobacz więcej →</a>
    </div>
    <div id="historyGrid" class="history-grid"></div>
  </section>

  <!-- 🔹 Dalej masz np. Polecane -->
  <section class="section">
    <div class="flex" style="justify-content:space-between">
      <h2>Polecane</h2>
      <a class="small" href="#" onclick="UI.search('', {sort:'rating'})">Najwyżej oceniane →</a>
    </div>

    </div></div></section>
      </main>

<footer>© <script>document.write(new Date().getFullYear())
// 🔹 Funkcja otwierająca edycję filmu
function editMovie(index) {
  const movies = JSON.parse(localStorage.getItem("movies") || "[]");
  const movie = movies[index];
  if (!movie) return alert("Film nie istnieje");

  document.getElementById("editIndex").value = index;
  document.getElementById("editTitle").value = movie.title;
  document.getElementById("editIframe").value = movie.iframe;
  document.getElementById("editThumbnail").value = movie.thumbnail;
  document.getElementById("editCategory").value = movie.category || "";
  document.getElementById("editPoints").value = movie.points || 0;

  document.getElementById("editModal").style.display = "block";
}

// 🔹 Funkcja zapisująca edycję filmu
function saveMovieEdit() {
  const index = document.getElementById("editIndex").value;
  let movies = JSON.parse(localStorage.getItem("movies") || "[]");

  movies[index] = {
    ...movies[index],
    title: document.getElementById("editTitle").value,
    iframe: document.getElementById("editIframe").value,
    thumbnail: document.getElementById("editThumbnail").value,
    category: document.getElementById("editCategory").value,
    points: parseInt(document.getElementById("editPoints").value) || 0
  };

  localStorage.setItem("movies", JSON.stringify(movies));
  alert("Film zaktualizowany!");
  document.getElementById("editModal").style.display = "none";
  location.reload();
}

</script>2025 StreamingHub • version 1.21 </footer>

<script>
/* =========================
   Simple localStorage "DB"
   ========================= */
const DB = (()=>{
  const key = 'cda-single-db-v1';
  const nowISO = ()=> new Date().toISOString();
  const def = {
    users: [],
    movies: [],
    categories: [
      {id:1,name:"Akcja"},{id:2,name:"Komedia"},{id:3,name:"Horror"},{id:4,name:"Sci-Fi"},{id:5,name:"Anime"},{id:6,name:"Dokument"},{id:7,name:"Bajki"}
    ],
    comments: [], // {id, movieId, userId, text, createdAt}
    ratings: [], // {userId, movieId, score}
    history: [], // {userId, movieId, watchedAt}
    wishlist: [], // {userId, movieId}
    friends: [], // {userId, friendId}
    codes: [], // {code, type, amount, limitLeft, days, expires}
    unlocks: [], // {userId, movieId}
    pointsLog: [], // {userId, change, reason, createdAt}
    sessions: { currentUserId: null }
  };
  function load(){
    try {
      const s = JSON.parse(localStorage.getItem(key) || 'null');
      return s ? s : def;
    } catch { return def; }
  }
  function save(db){ localStorage.setItem(key, JSON.stringify(db)); }
  let db = load();

  // ensure admin
  function ensureAdmin(){
    const email="tomaszjasinski60@gmail.com";
    let u = db.users.find(u=>u.email===email);
    if(!u){
      u = { id:1, email, pass:"cannon098", username:"Admin", bio:"Administrator", isAdmin:true, points:0, premiumUntil:null };
      db.users.push(u);
      save(db);
    } else {
      u.isAdmin = true;
      save(db);
    }
  }
  // seed movie
  function ensureDemoMovie(){
    if(db.movies.length===0){
      db.movies.push({
        id:1,
        title:"Przykładowy film (demo)",
        description:"To jest przykładowy film z publiczną miniaturą i przykładowym iframe.",
        iframe:"https://www.youtube.com/embed/dQw4w9WgXcQ",
        thumb:"https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?q=80&w=1200&auto=format&fit=crop",
        categoryId:1,
        year:2020,
        lengthMin:210,
        pointsRequired:100,
        createdAt: nowISO()
      });
      save(db);
    }
  }
  ensureAdmin();
  ensureDemoMovie();

  return {
    get: ()=>db,
    set: (next)=>{ db = next; save(db); },
    save,
    nowISO,
    nextId: (arr)=> arr.reduce((m,x)=>Math.max(m,x.id||0),0)+1,
  };
})();

/* =========================
   Auth
   ========================= */
const Auth = {
  current(){ const { sessions, users } = DB.get(); return users.find(u=>u.id===sessions.currentUserId) || null; },
  login(email, pass){
    const db = DB.get();
    const u = db.users.find(u=>u.email===email && u.pass===pass);
    if(!u) throw new Error("Złe dane logowania");
    db.sessions.currentUserId = u.id;
    DB.save(db);
    UI.flash("Zalogowano ✔️");
    UI.updateHeader();
    UI.show('home');
  },
  register(username, email, pass){
    const db = DB.get();
    if(db.users.some(u=>u.email===email)) throw new Error("Email zajęty");
    const id = DB.nextId(db.users);
    db.users.push({ id, email, pass, username, bio:"", isAdmin:false, points:0, premiumUntil:null });
    db.sessions.currentUserId = id;
    DB.save(db);
    UI.flash("Konto utworzone ✔️");
    UI.updateHeader();
    UI.show('home');
  },
  logout(){
    const db = DB.get();
    db.sessions.currentUserId = null;
    DB.save(db);
    UI.updateHeader();
    UI.show('home');
  }
};

/* =========================
   Helpers
   ========================= */
function avgRating(movieId){
  const { ratings } = DB.get();
  const r = ratings.filter(x=>x.movieId===movieId);
  if(!r.length) return null;
  return (r.reduce((a,b)=>a+b.score,0)/r.length).toFixed(1);
}
function userCanWatch(user, movie){
  if(!user) return false;
  if(movie.pointsRequired===0) return true;
  if(premiumActive(user)) return true;
  const { unlocks } = DB.get();
  return !!unlocks.find(u=>u.userId===user.id && u.movieId===movie.id);
}
function premiumActive(user){
  if(!user || !user.premiumUntil) return false;
  return new Date(user.premiumUntil) > new Date();
}
function addPoints(userId, amount, reason){
  const db = DB.get();
  const u = db.users.find(u=>u.id===userId);
  if(!u) return;
  u.points = (u.points||0) + amount;
  db.pointsLog.push({userId, change: amount, reason: reason||"", createdAt: DB.nowISO()});
  DB.save(db);
}
function spendPoints(userId, amount, reason){
  const db = DB.get();
  const u = db.users.find(u=>u.id===userId);
  if(!u) return false;
  if((u.points||0) < amount) return false;
  u.points -= amount;
  db.pointsLog.push({userId, change: -amount, reason: reason||"", createdAt: DB.nowISO()});
  DB.save(db);
  return true;
}
function ensureUnlocked(userId, movieId){
  const db = DB.get();
  if(!db.unlocks.find(u=>u.userId===userId && u.movieId===movieId)){
    db.unlocks.push({userId, movieId});
    DB.save(db);
  }
}
function leaderboard(days){
  const db = DB.get();
  const since = Date.now() - days*24*60*60*1000;
  const byUser = new Map();
  db.pointsLog.forEach(p=>{
    if(new Date(p.createdAt).getTime() >= since && p.change>0){
      byUser.set(p.userId, (byUser.get(p.userId)||0) + p.change);
    }
  });
  const rows = [...byUser.entries()].map(([userId,gained])=>({userId, gained}));
  rows.sort((a,b)=>b.gained - a.gained);
  return rows.slice(0,100).map((r,i)=>({rank:i+1, user: db.users.find(u=>u.id===r.userId)?.username||'?', gained:r.gained}));
}

/* =========================
   UI Rendering
   ========================= */
const UI = {
  el: ()=>document.getElementById('app'),
  state: { view:'home', params:{} },
  flash(msg){
    const div = document.createElement('div');
    div.className = 'alert';
    div.textContent = msg;
    div.style.position='fixed'; div.style.right='16px'; div.style.bottom='16px'; div.style.zIndex='9999';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),2000);
  },
  updateHeader(){
    const u = Auth.current();
    document.getElementById('adminLink').classList.toggle('hidden', !(u&&u.isAdmin));
    document.getElementById('logoutForm').classList.toggle('hidden', !u);
    document.getElementById('authLinks').classList.toggle('hidden', !!u);
  },
  show(view, params={}){
    UI.state.view=view; UI.state.params=params;
    const app = UI.el();
    const db = DB.get();
    const user = Auth.current();
    // Router
    if(view==='home'){
      const featured = [...db.movies].sort((a,b)=> (b.pointsRequired||0)-(a.pointsRequired||0)).slice(0,12);
      const newest = [...db.movies].sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)).slice(0,12);
      const top = [...db.movies].sort((a,b)=> (parseFloat(avgRating(b.id)||0) - parseFloat(avgRating(a.id)||0))).slice(0,12);
      app.innerHTML = `
        ${UI.filters()}
        <section class="section"><div class="flex" style="justify-content:space-between"><h2>Polecane</h2><a class="small" href="#" onclick="UI.search('', {sort:'rating'})">Najwyżej oceniane →</a></div>
          <div class="grid">${featured.map(UI.card).join('')}</div></section>
        <section class="section"><h2>Nowo dodane</h2><div class="grid">${newest.map(UI.card).join('')}</div></section>
        <section class="section"><h2>Najwyżej oceniane</h2><div class="grid">${top.map(UI.card).join('')}</div></section>
      `;
    }
    else if(view==='movie'){
      const m = db.movies.find(x=>x.id===params.id);
      if(!m){ app.innerHTML = "<div class='alert'>Nie znaleziono.</div>"; return; }
      const comm = db.comments.filter(c=>c.movieId===m.id).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      const rAvg = avgRating(m.id) || '-';
      const youRated = user ? db.ratings.find(r=>r.userId===user.id && r.movieId===m.id) : null;
      const canWatch = userCanWatch(user, m);
      app.innerHTML = `
        <div class="flex" style="justify-content:space-between;">
          <div>
            <h1>${m.title}</h1>
            <div class="small">Rok: ${m.year||'?'} • Długość: ${m.lengthMin||'?'} min</div>
            ${m.pointsRequired ? `<div class="mt-2 alert">Wymagane punkty do odblokowania: <strong>${m.pointsRequired}</strong></div>` : ''}
          </div>
          <div class="flex">${user? `<button class="btn secondary" onclick="UI.toggleWishlist(${m.id})">Chcę obejrzeć</button>`:''}</div>
        </div>
        <img class="mt-4" src="${m.thumb}" style="width:100%;max-height:360px;object-fit:cover;border-radius:14px">
        <div class="mt-4"><p>${m.description||'Brak opisu.'}</p></div>
        <div class="mt-4">
          ${user ? (canWatch ? `<a class="btn" href="#" onclick="UI.show('watch',{id:${m.id}})">Oglądaj</a>` :
            `<button class="btn" onclick="UI.unlock(${m.id})">Odblokuj za punkty</button><div class="small mt-2">Masz: ${user.points||0} pkt</div>`) :
            `<a class="btn" href="#" onclick="UI.show('login')">Zaloguj, aby oglądać</a>`}
        </div>
        <hr class="mt-8">
        <section class="mt-4">
          <h3>Oceny</h3>
          <div class="flex">
            <div>Średnia: <strong>${rAvg}</strong>/10</div>
            ${user ? `
              <form class="flex" onsubmit="event.preventDefault(); UI.rate(${m.id}, this.score.value)">
                <select name="score">${Array.from({length:10},(_,i)=>i+1).map(i=>`<option value="${i}" ${youRated&&youRated.score===i?'selected':''}>${i}</option>`).join('')}</select>
                <button class="btn secondary">Oceń</button>
              </form>` : ''}
          </div>
        </section>
        <section class="mt-4">
          <h3>Komentarze</h3>
          ${user ? `
            <form onsubmit="event.preventDefault(); UI.comment(${m.id}, this.text.value); this.reset();">
              <textarea name="text" rows="3" placeholder="Napisz komentarz..."></textarea>
              <button class="btn mt-2">Dodaj</button>
            </form>` : `<div class="alert">Zaloguj się, aby dodać komentarz.</div>`}
          <div class="mt-4">
            ${comm.map(c=>`
              <div class="card" style="padding:12px">
                <div class="small"><strong>${DB.get().users.find(u=>u.id===c.userId)?.username||"?"}</strong> • ${new Date(c.createdAt).toLocaleString()}</div>
                <div class="mt-2">${escapeHtml(c.text)}</div>
              </div>`).join('')}
          </div>
        </section>
      `;
    }
    else if(view==='watch'){
      const m = db.movies.find(x=>x.id===params.id);
      if(!m){ app.innerHTML = "<div class='alert'>Nie znaleziono.</div>"; return; }
      if(!userCanWatch(user, m)){ UI.show('movie',{id:m.id}); return; }
      ensureUnlocked(user.id, m.id);
      db.history.push({userId:user.id, movieId:m.id, watchedAt: DB.nowISO()}); DB.save(db);
      app.innerHTML = `
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h1>Odtwarzacz: ${m.title}</h1>
          <a class="btn secondary" href="#" onclick="UI.show('movie',{id:${m.id}})">← Powrót</a>
        </div>
        <div class="video-container"><iframe class="player mt-4" src="${m.iframe}" allowfullscreen></iframe><div class="overlay-block"></div></div>
        <div class="small mt-2">Jakość, głośność i prędkość są po stronie hostingu iframe. Tryb nocny: użyj motywu systemu.</div>
      `;
    }
    else if(view==='login'){
      app.innerHTML = `
        <h1>Logowanie</h1>
        <form class="mt-4" onsubmit="event.preventDefault(); Auth.login(this.email.value, this.password.value)">
          <label>Email</label><input required type="text" name="email">
          <label>Hasło</label><input required type="password" name="password">
          <button class="btn mt-4">Zaloguj</button>
        </form>
        <p class="small mt-2">Nie masz konta? <a href="#" onclick="UI.show('register')">Zarejestruj się</a></p>
      `;
    }
    else if(view==='register'){
      app.innerHTML = `
        <h1>Rejestracja</h1>
        <form class="mt-4" onsubmit="event.preventDefault(); Auth.register(this.username.value, this.email.value, this.password.value)">
          <label>Nick</label><input required type="text" name="username">
          <label>Email</label><input required type="text" name="email">
          <label>Hasło (min 6 znaków)</label><input required type="password" name="password" minlength="6">
          <button class="btn mt-4">Utwórz konto</button>
        </form>
      `;
    }
    else if(view==='me'){
      if(!user){ UI.show('login'); return; }
      const hist = db.history.filter(h=>h.userId===user.id).sort((a,b)=> new Date(b.watchedAt)-new Date(a.watchedAt)).slice(0,100);
      const wish = db.wishlist.filter(w=>w.userId===user.id).map(w=>({movieId:w.movieId, ...db.movies.find(m=>m.id===w.movieId)}));
      const friends = db.friends.filter(f=>f.userId===user.id).map(f=> db.users.find(u=>u.id===f.friendId));
      app.innerHTML = `
        <h1>Mój profil</h1>
        <div class="grid" style="grid-template-columns:2fr 1fr;gap:16px">
          <div class="card p">
            <h3>Profil</h3>
            <p><strong>${user.username}</strong></p>
            <p>Punkty: <strong>${user.points||0}</strong> ${user.premiumUntil?` • Premium do: ${new Date(user.premiumUntil).toLocaleDateString()}`:''}</p>
            <form onsubmit="event.preventDefault(); UI.saveBio(this.bio.value)">
              <label>Opis</label>
              <textarea name="bio" rows="3">${user.bio||''}</textarea>
              <button class="btn mt-2">Zapisz</button>
            </form>
            <div class="mt-4">
              <button class="btn" onclick="UI.earnAd()">+50 pkt za reklamę</button> <span class="small">(demo)</span>
              <form class="flex mt-2" onsubmit="event.preventDefault(); UI.redeem(this.code.value)">
                <input type="text" name="code" placeholder="Kod premium/punkty">
                <button class="btn secondary">Użyj kodu</button>
              </form>
            </div>
          </div>
          <div class="card p">
            <h3>Znajomi</h3>
            ${friends.length? `<ul>${friends.map(f=>`<li>${f.username}</li>`).join('')}</ul>` : `<div class="small">Brak znajomych.</div>`}
          </div>
        </div>
        <div class="mt-4">
          <h3>Historia oglądania</h3>
          <div class="grid">${hist.map(h=> UI.card(db.movies.find(m=>m.id===h.movieId))).join('')}</div>
        </div>
        <div class="mt-4">
          <h3>Lista „Chcę obejrzeć”</h3>
          <div class="grid">${wish.map(w=> UI.card(w)).join('')}</div>
        </div>
      `;
    }
    else if(view==='top'){
      const week = leaderboard(7);
      const month = leaderboard(30);
      app.innerHTML = `
        <h1>Ranking punktów</h1>
        <h3>Tydzień</h3>
        <table><tr><th>#</th><th>Użytkownik</th><th>Punkty zdobyte</th></tr>
        ${week.map(r=>`<tr><td>${r.rank}</td><td>${r.user}</td><td>${r.gained}</td></tr>`).join('')}</table>
        <h3 class="mt-4">Miesiąc</h3>
        <table><tr><th>#</th><th>Użytkownik</th><th>Punkty zdobyte</th></tr>
        ${month.map(r=>`<tr><td>${r.rank}</td><td>${r.user}</td><td>${r.gained}</td></tr>`).join('')}</table>
      `;
    }
    else if(view==='admin'){
      if(!(user && user.isAdmin)){ app.innerHTML = "<div class='alert'>Brak dostępu.</div>"; return; }
      app.innerHTML = UI.adminPanel();
    }
    else if(view==='search'){
      const q = params.q?.trim().toLowerCase() || '';
      const { cat, year, len, sort } = params;
      let res = db.movies.filter(m=> !q || m.title.toLowerCase().includes(q));
      if(cat) res = res.filter(m=> m.categoryId==cat);
      if(year) res = res.filter(m=> String(m.year)==String(year));
      if(len) res = res.filter(m=> (m.lengthMin||0) >= Number(len));
      if(sort==='rating') res.sort((a,b)=> (parseFloat(avgRating(b.id)||0) - parseFloat(avgRating(a.id)||0)));
      if(sort==='new') res.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      app.innerHTML = UI.filters(params) + `<h3 class="mt-4">Wyniki</h3><div class="grid">${res.map(UI.card).join('') || '<div class="small">Brak wyników.</div>'}</div>`;
    }
  },
  filters(params={}){
    const db = DB.get();
    const p = Object.assign({ cat:'', year:'', len:'', sort:'rating', q:'' }, params||{});
    return `
    <section class="section mt-8">
      <h2>Filtruj</h2>
      <form class="form" onsubmit="event.preventDefault(); UI.search(this.q.value, {cat:this.cat.value, year:this.year.value, len:this.len.value, sort:this.sort.value})">
        <div class="form-row">
          <div><label>Kategoria</label>
            <select name="cat"><option value="">—</option>${db.categories.map(c=>`<option value="${c.id}" ${p.cat==c.id?'selected':''}>${c.name}</option>`).join('')}</select>
          </div>
          <div><label>Rok</label><input type="number" name="year" value="${p.year||''}"></div>
        </div>
        <div class="form-row">
          <div><label>Min. długość (min)</label><input type="number" name="len" value="${p.len||''}"></div>
          <div><label>Sortowanie</label>
            <select name="sort">
              <option value="rating" ${p.sort==='rating'?'selected':''}>Ocena</option>
              <option value="new" ${p.sort==='new'?'selected':''}>Najnowsze</option>
            </select>
          </div>
        </div>
        <label>Szukaj</label><input type="text" name="q" value="${p.q||''}" placeholder="Tytuł...">
        <button class="btn mt-4">Szukaj</button>
      </form>
    </section>`;
  },
  search(q, extra={}){ UI.show('search', { q, ...extra }); },
  card(m){
    if(!m) return '';
    const ar = avgRating(m.id);
    return `<div class="card">
      <a href="#" onclick="UI.show('movie',{id:${m.id}})"><img src="${m.thumb}" alt="${escapeHtml(m.title)}"></a>
      <div class="card p">
        <div class="flex" style="justify-content:space-between;">
          <strong><a href="#" onclick="UI.show('movie',{id:${m.id}})">${escapeHtml(m.title)}</a></strong>
          <span class="badge">★ ${ar?ar:'-'}</span>
        </div>
        <div class="small mt-2">czas: ${m.lengthMin||'?'} min • rok: ${m.year||'?'}</div>
      </div>
    </div>`;
  },
  toggleWishlist(movieId){
    const db = DB.get(); const u = Auth.current(); if(!u) return;
    const ex = db.wishlist.find(w=>w.userId===u.id && w.movieId===movieId);
    if(ex) db.wishlist = db.wishlist.filter(w=> !(w.userId===u.id && w.movieId===movieId));
    else db.wishlist.push({userId:u.id, movieId});
    DB.save(db); UI.flash("Zaktualizowano listę.");
  },
  unlock(movieId){
    const db = DB.get(); const u = Auth.current(); const m = db.movies.find(x=>x.id===movieId);
    if(!u) return UI.show('login');
    if(userCanWatch(u,m)) return UI.show('watch',{id:m.id});
    if(!m.pointsRequired) return UI.show('watch',{id:m.id});
    if(!spendPoints(u.id, m.pointsRequired, `Odblokowanie: ${m.title}`)) return UI.flash("Za mało punktów");
    ensureUnlocked(u.id, m.id);
    UI.flash("Odblokowano ✔️");
    UI.show('watch',{id:m.id});
  },
  rate(movieId, score){
    const db = DB.get(); const u = Auth.current(); if(!u) return;
    score = Number(score);
    const ex = db.ratings.find(r=>r.userId===u.id && r.movieId===movieId);
    if(ex) ex.score = score; else db.ratings.push({userId:u.id, movieId, score});
    DB.save(db); UI.flash("Dziękujemy za ocenę!");
    UI.show('movie',{id:movieId});
  },
  comment(movieId, text){
    const db = DB.get(); const u = Auth.current(); if(!u) return;
    text = (text||'').trim(); if(!text) return;
    const id = DB.nextId(db.comments);
    db.comments.push({id, movieId, userId:u.id, text: text.slice(0,2000), createdAt: DB.nowISO()});
    DB.save(db); UI.show('movie',{id:movieId});
  },
  
saveProfile(newName, newAvatar){
  const db = DB.get();
  const u = Auth.current();
  if(!u) return;
  const me = db.users.find(x=>x.id===u.id);
  if(newName) me.username = newName.trim().slice(0,50);
  if(newAvatar) me.avatar = newAvatar.trim();
  DB.save(db);
  UI.flash("Profil zaktualizowany ✔️");
  UI.show('me');
},

saveBio(bio){
    const db = DB.get(); const u = Auth.current(); if(!u) return;
    const me = db.users.find(x=>x.id===u.id); me.bio = (bio||'').slice(0,300);
    DB.save(db); UI.flash("Zapisano ✔️"); UI.show('me');
  },
  earnAd(){
    const u = Auth.current(); if(!u) return UI.show('login');
    let gain = 50;
    if(premiumActive(u)) gain *= 2;
    addPoints(u.id, gain, "Oglądnięcie reklamy (demo)");
    UI.flash(`Zdobyto ${gain} pkt`); UI.show('me');
  },
  redeem(codeStr){
    const db = DB.get(); const u = Auth.current(); if(!u) return UI.show('login');
    const c = db.codes.find(c=>c.code.toUpperCase()===String(codeStr||'').trim().toUpperCase());
    if(!c) { UI.flash("Nieprawidłowy kod"); return; }
    if(c.limitLeft<=0) { UI.flash("Wyczerpany limit użyć"); return; }
    if(c.expires && new Date(c.expires) < new Date()){ UI.flash("Kod wygasł"); return; }
    if(c.type==='points'){
      addPoints(u.id, c.amount, `Kod: ${c.code}`);
    } else if(c.type==='premium'){
      const days = Number(c.days||c.amount||7);
      const base = u.premiumUntil ? new Date(u.premiumUntil) : new Date();
      const start = base>new Date()? base : new Date();
      const until = new Date(start.getTime() + days*24*60*60*1000);
      u.premiumUntil = until.toISOString();
      DB.save(db);
    }
    c.limitLeft -= 1; DB.save(db);
    UI.flash("Kod zrealizowany ✔️");
    UI.show('me');
  },
  adminPanel(){
    const db = DB.get();
    const moviesRows = db.movies.map(m=>`
      <tr>
        <td><a href="#" onclick="UI.show('movie',{id:${m.id}})">${escapeHtml(m.title)}</a></td>
        <td>${m.pointsRequired||0}</td>
        <td><button class="btn secondary" onclick="UI.deleteMovie(${m.id})">Usuń</button></td>
      </tr>`).join('');
    const codesRows = db.codes.map(c=>`
      <tr><td>${c.code}</td><td>${c.type}</td><td>${c.amount}</td><td>${c.limitLeft}</td><td>${c.expires||'-'}</td></tr>`).join('');
    return `
      <h1>Panel admina</h1>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
        <div class="card p">
          <h3>Dodaj film</h3>
          <form onsubmit="event.preventDefault(); UI.addMovie(this)">
            <label>Tytuł</label><input name="title" required>
            <label>Opis</label><textarea name="description"></textarea>
            <label>Link miniatury (URL)</label><input name="thumb" required>
            <label>Iframe src (URL hostingu)</label><input name="iframe" required placeholder="https://...">
            <div class="form-row">
              <div>
                <label>Kategoria</label>
                <select name="categoryId">
                  ${db.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
                </select>
              </div>
              <div><label>Rok</label><input type="number" name="year"></div>
            </div>
            <div class="form-row">
              <div><label>Długość (min)</label><input type="number" name="lengthMin"></div>
              <div><label>Punkty wymagane</label><input type="number" name="pointsRequired" value="0"></div>
            </div>
            <button class="btn mt-2">Dodaj</button>
          </form>
        </div>
        <div class="card p">
          <h3>Kategorie</h3>
          <form class="flex" onsubmit="event.preventDefault(); UI.addCategory(this.name.value); this.reset();">
            <input name="name" placeholder="Nazwa kategorii">
            <button class="btn secondary">Dodaj</button>
          </form>
          <div class="mt-2">${db.categories.map(c=>`<span class="tag">${c.name} <a href="#" onclick="UI.delCategory(${c.id})">×</a></span>`).join('')}</div>
        </div>
        <div class="card p">
          <h3>Kody (punkty/premium)</h3>
          <form onsubmit="event.preventDefault(); UI.addCode(this)">
            <div class="form-row">
              <div>
                <label>Typ</label>
                <select name="type"><option value="points">punkty</option><option value="premium">premium</option></select>
              </div>
              <div><label>Ilość punktów / dni premium</label><input type="number" name="amount" required></div>
            </div>
            <div class="form-row">
              <div><label>Limit użyć</label><input type="number" name="limitLeft" value="100"></div>
              <div><label>Dni premium (opcjonalnie)</label><input type="number" name="days"></div>
            </div>
            <label>Data ważności (opcjonalnie)</label><input type="date" name="expires">
            <button class="btn mt-2">Utwórz kod</button>
          </form>
          <table class="mt-2"><tr><th>Kod</th><th>Typ</th><th>Amount</th><th>Pozostało</th><th>Wygasa</th></tr>${codesRows}</table>
        </div>
        <div class="card p">
          <h3>Lista filmów</h3>
          <table><tr><th>Tytuł</th><th>Punkty</th><th></th></tr>${moviesRows}</table>
        </div>
      </div>
    `;
  },
  addMovie(form){
    const db = DB.get();
    const id = DB.nextId(db.movies);
    db.movies.push({
      id,
      title: form.title.value.trim(),
      description: form.description.value.trim(),
      thumb: form.thumb.value.trim(),
      iframe: form.iframe.value.trim(),
      categoryId: Number(form.categoryId.value),
      year: form.year.value? Number(form.year.value) : null,
      lengthMin: form.lengthMin.value? Number(form.lengthMin.value) : null,
      pointsRequired: form.pointsRequired.value? Number(form.pointsRequired.value) : 0,
      createdAt: DB.nowISO()
    });
    DB.save(db); UI.flash("Film dodany ✔️"); UI.show('admin');
  },
  
deleteMovie(id){
  const db = DB.get();
  // usuń film
  db.movies = db.movies.filter(m=>m.id!==id);
  // usuń komentarze przypisane do tego filmu
  db.comments = db.comments.filter(c=>c.movieId!==id);
  // usuń oceny przypisane do tego filmu
  db.ratings = db.ratings.filter(r=>r.movieId!==id);
  // usuń historię oglądania
  db.history = db.history.filter(h=>h.movieId!==id);
  // usuń z listy "Chcę obejrzeć"
  db.wishlist = db.wishlist.filter(w=>w.movieId!==id);
  // usuń odblokowania
  db.unlocks = db.unlocks.filter(u=>u.movieId!==id);
  DB.save(db);
  UI.show('admin');
}
,
  addCategory(name){
    name = (name||'').trim(); if(!name) return;
    const db = DB.get();
    const id = DB.nextId(db.categories);
    db.categories.push({id, name}); DB.save(db); UI.show('admin');
  },
  delCategory(id){
    const db = DB.get();
    db.categories = db.categories.filter(c=>c.id!==id);
    DB.save(db); UI.show('admin');
  },
  addCode(form){
    const db = DB.get();
    const code = Math.random().toString(36).slice(2,12).toUpperCase();
    const type = form.type.value;
    const amount = Number(form.amount.value);
    const limitLeft = Number(form.limitLeft.value||1);
    const days = form.days.value? Number(form.days.value) : null;
    const expires = form.expires.value || null;
    db.codes.push({ code, type, amount, limitLeft, days, expires });
    DB.save(db); UI.flash(`Utworzono kod: ${code}`); UI.show('admin');
  }
};

function escapeHtml(str){
  return (str||'').replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[s]));
}

// initial render
UI.updateHeader();
UI.show('home');
</script>




  <script>
  // 🔹 Historia w localStorage
  const historyGrid = document.getElementById("historyGrid");
  const toggleBtn = document.getElementById("toggleHistory");
  let expanded = false;

  function getHistory() {
    return JSON.parse(localStorage.getItem("watchHistory") || "[]");
  }

  function saveHistory(history) {
    localStorage.setItem("watchHistory", JSON.stringify(history));
  }

  function addToHistory(movie) {
    let history = getHistory();
    history = history.filter(item => item.id !== movie.id);
    history.unshift(movie);
    saveHistory(history);
    renderHistory();
  }

  function renderHistory() {
    const history = getHistory();
    historyGrid.innerHTML = "";
    history.forEach((m, i) => {
      const item = document.createElement("div");
      item.className = "history-item";
      item.innerHTML = `
        <a href="#" onclick="UI.show('movie',{id:${m.id}})">
          <img src="${m.img}" style="width:100%;border-radius:8px;">
          <div>${m.title}</div>
        </a>`;
      if (!expanded && i >= 6) item.style.display = "none";
      historyGrid.appendChild(item);
    });
    toggleBtn.textContent = expanded ? "zobacz mniej ↑" : "zobacz więcej →";
  }

  toggleBtn.addEventListener("click", e => {
    e.preventDefault();
    expanded = !expanded;
    renderHistory();
  });

  const originalShow = UI.show;
  UI.show = function(view, opts) {
    if (view === "movie" && opts?.id) {
      const card = document.querySelector(`[onclick*="id:${opts.id}"]`)?.closest(".card");
      if (card) {
        const img = card.querySelector("img")?.src || "";
        const title = card.querySelector("strong a")?.innerText || "Film";
        addToHistory({id: opts.id, title, img});
      }
    }
    return originalShow.apply(this, arguments);
  };

  renderHistory();

  </script><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
<script>
  const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0"; // Twój public anon key

  // ⬇️ TO jest właściwe dla wersji CDN/global
  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadMovies() {
    const { data, error } = await db.from("movies").select("*");
    if (error) {
      console.error("Błąd:", error);
      return;
    }
    console.log("📺 Filmy z Supabase:", data);
    const container = document.getElementById("movies-container");
    container.innerHTML = "";
    data.forEach(movie => {
      const div = document.createElement("div");
      div.className = "movie-card";
      div.innerHTML = `
        <h3>${movie.title}</h3>
        <img src="${movie.thumbnail_url}" width="200">
        <p>Rok: ${movie.year}, Czas: ${movie.duration} min</p>
      `;
      container.appendChild(div);
    });
  }

    // --- Twój kod JS do pobierania z Supabase ---
    document.addEventListener("DOMContentLoaded", loadMovies);
  </script>
  <section id="movies">
    <h2>🎬 Filmy z bazy</h2>
    <div id="movies-container"></div>
  </section>

</body>
</html>


</body></html>