<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>üé¨ Mini Netflix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { background-color: #0f0f0f; color: #fff; font-family: sans-serif; }
    .movie-card img { border-radius: 0.75rem; transition: transform .3s; }
    .movie-card:hover img { transform: scale(1.05); }
    .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; }
    .video-container iframe, .video-container video {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-zinc-900 p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">üé¨ Mini Netflix</h1>
    <nav class="space-x-4">
      <button onclick="UI.showSection('movies')" class="hover:underline">Filmy</button>
      <button onclick="UI.showSection('profile')" class="hover:underline">Profil</button>
      <button onclick="UI.showSection('login')" id="loginBtn" class="hover:underline">Logowanie</button>
      <button onclick="Auth.logout()" id="logoutBtn" class="hidden hover:underline">Wyloguj</button>
    </nav>
  </header>

  <!-- Main content -->
  <main class="flex-1 p-4 space-y-6">

    <!-- Filmy -->
    <section id="moviesSection">
      <h2 class="text-2xl font-semibold mb-4">üìΩÔ∏è Filmy</h2>
      <div id="movies-container" class="grid gap-4 grid-cols-2 md:grid-cols-4"></div>
    </section>

    <!-- Profil -->
    <section id="profileSection" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">üë§ Profil</h2>
      <div id="profileInfo" class="mb-4"></div>
      <button onclick="Points.showAd()" id="earnAdBtn" class="bg-green-600 px-4 py-2 rounded">+ Punkty za reklamƒô</button>
      <p id="cooldownInfo" class="text-sm text-zinc-400 mt-2"></p>
    </section>

    <!-- Logowanie/Rejestracja -->
    <section id="loginSection" class="hidden">
      <h2 class="text-2xl font-semibold mb-4">üîë Logowanie</h2>
      <form onsubmit="Auth.loginForm(event)" class="space-y-2">
        <input type="email" id="loginEmail" placeholder="Email" class="w-full p-2 rounded text-black">
        <input type="password" id="loginPass" placeholder="Has≈Ço" class="w-full p-2 rounded text-black">
        <button class="bg-blue-600 px-4 py-2 rounded w-full">Zaloguj</button>
      </form>
      <h3 class="mt-6 text-xl">üìù Rejestracja</h3>
      <form onsubmit="Auth.registerForm(event)" class="space-y-2">
        <input type="text" id="regUsername" placeholder="Nick" class="w-full p-2 rounded text-black">
        <input type="email" id="regEmail" placeholder="Email" class="w-full p-2 rounded text-black">
        <input type="password" id="regPass" placeholder="Has≈Ço" class="w-full p-2 rounded text-black">
        <button class="bg-green-600 px-4 py-2 rounded w-full">Zarejestruj</button>
      </form>
    </section>

  </main>

  <!-- Footer -->
  <footer class="bg-zinc-900 p-4 text-center text-sm text-zinc-400">
    &copy; <span id="year"></span> Mini Netflix
  </footer>

  <!-- Modal player -->
  <div id="playerModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50">
    <div class="w-full max-w-4xl p-4">
      <button onclick="UI.closePlayer()" class="text-white float-right mb-2">‚úñ</button>
      <div id="playerBox" class="video-container"></div>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========== AUTH ==========
const Auth = {
  async loginForm(e){
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    const pass = document.getElementById("loginPass").value;
    const { data, error } = await db.auth.signInWithPassword({ email, password: pass });
    if(error) return alert(error.message);
    UI.updateUI();
  },
  async registerForm(e){
    e.preventDefault();
    const username = document.getElementById("regUsername").value;
    const email = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPass").value;
    const { data, error } = await db.auth.signUp({ email, password: pass });
    if(error) return alert(error.message);
    await db.from("profiles").insert({ id: data.user.id, username });
    UI.updateUI();
  },
  async logout(){
    await db.auth.signOut();
    UI.updateUI();
  },
  async user(){
    const { data: { user } } = await db.auth.getUser();
    return user;
  }
};

// ========== UI ==========
const UI = {
  showSection(name){
    document.getElementById("moviesSection").classList.add("hidden");
    document.getElementById("profileSection").classList.add("hidden");
    document.getElementById("loginSection").classList.add("hidden");
    if(name==="movies") document.getElementById("moviesSection").classList.remove("hidden");
    if(name==="profile") document.getElementById("profileSection").classList.remove("hidden");
    if(name==="login") document.getElementById("loginSection").classList.remove("hidden");
  },
  async updateUI(){
    const user = await Auth.user();
    if(user){
      document.getElementById("loginBtn").classList.add("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      UI.showSection("movies");
      UI.loadProfile();
    } else {
      document.getElementById("loginBtn").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.add("hidden");
      UI.showSection("login");
    }
    Movies.load();
  },
  async loadProfile(){
    const user = await Auth.user();
    if(!user) return;
    const { data } = await db.from("profiles").select("*").eq("id", user.id).single();
    document.getElementById("profileInfo").innerHTML = `
      <p><b>Nick:</b> ${data.username}</p>
      <p><b>Punkty:</b> ${data.points}</p>
    `;
  },
  openPlayer(url){
    document.getElementById("playerModal").classList.remove("hidden");
    document.getElementById("playerBox").innerHTML = `<iframe src="${url}" allowfullscreen></iframe>`;
  },
  closePlayer(){
    document.getElementById("playerModal").classList.add("hidden");
    document.getElementById("playerBox").innerHTML = "";
  }
};

// ========== Movies ==========
const Movies = {
  async load(){
    const { data, error } = await db.from("movies").select("*").order("created_at",{ascending:false});
    if(error) return console.error(error);
    const container = document.getElementById("movies-container");
    container.innerHTML="";
    for(const m of data){
      container.innerHTML += `
        <div class="movie-card cursor-pointer" onclick="Movies.tryWatch('${m.id}','${m.video_url}',${m.points_required})">
          <img src="${m.thumbnail_url}" alt="${m.title}" class="w-full h-48 object-cover">
          <h3 class="mt-2 font-semibold">${m.title}</h3>
          <p class="text-sm text-zinc-400">${m.year} ‚Ä¢ ${m.duration} min</p>
          <p class="text-sm">üéüÔ∏è ${m.points_required} pkt</p>
        </div>
      `;
    }
  },
  async tryWatch(id, url, cost){
    const user = await Auth.user();
    if(!user) return alert("Musisz byƒá zalogowany!");
    const { data: profile } = await db.from("profiles").select("*").eq("id",user.id).single();
    const { data: unlocked } = await db.from("unlocks").select("*").eq("user_id",user.id).eq("movie_id",id).maybeSingle();
    if(unlocked || profile.points >= cost){
      if(!unlocked){
        await db.from("profiles").update({ points: profile.points - cost }).eq("id",user.id);
        await db.from("unlocks").insert({ movie_id:id, user_id:user.id });
      }
      UI.openPlayer(url);
      UI.loadProfile();
    } else {
      alert("Za ma≈Ço punkt√≥w! Obejrzyj reklamƒô by zdobyƒá.");
    }
  }
};

// ========== Points ==========
const Points = {
  cooldown: false,
  async showAd(){
    if(this.cooldown) return alert("Poczekaj minutƒô!");
    const adBox = document.getElementById("adBox");
    adBox.innerHTML = `<iframe src="https://example.com/ad.html" class="w-full h-48"></iframe>`;
    setTimeout(async ()=>{
      const user = await Auth.user();
      if(user){
        await db.rpc("increment_points",{uid:user.id, pts:50});
        await db.from("points_log").insert({user_id:user.id, points:50, reason:"Ad"});
        UI.loadProfile();
      }
      adBox.innerHTML="";
      document.getElementById("cooldownInfo").textContent="OglƒÖda≈Çe≈õ reklamƒô, poczekaj 1 minutƒô";
      this.cooldown = true;
      setTimeout(()=>{this.cooldown=false; document.getElementById("cooldownInfo").textContent="";},60000);
    },30000);
  }
};

// ========== Helpers ==========
document.getElementById("year").textContent = new Date().getFullYear();
UI.updateUI();
</script>
</body>
</html>
