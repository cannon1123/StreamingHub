<html lang="pl"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>StreamingHub ‚Ä¢ Free video</title>
<style>
:root { --bg:#0b0d10; --card:#151922; --text:#e3e7ee; --muted:#a1a9b8; --brand:#4f7cff; --border:#232a37; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
a{color:var(--text);text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:rgba(11,13,16,.8);backdrop-filter:blur(6px);z-index:10}
.nav{display:flex;gap:12px;align-items:center;padding:12px 16px}
.brand{font-weight:800}
.nav input[type=search]{flex:1;background:#0e1218;border:1px solid var(--border);color:#fff;padding:10px 12px;border-radius:12px}
.menu a,.menu button{padding:8px 10px;color:var(--muted);background:none;border:none;cursor:pointer}
.btn{background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;border:none;cursor:pointer}
.btn.secondary{background:#2a3446}
.badge{font-size:12px;color:#fff;background:#2a3446;padding:2px 8px;border-radius:999px}
.grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.card.p{padding:12px}
.card img{width:100%;height:200px;object-fit:cover;display:block}
.small{font-size:12px;color:var(--muted)}
.section h2{margin:16px 0 8px}
.flex{display:flex;gap:12px;align-items:center}
.mt-2{margin-top:8px}.mt-4{margin-top:16px}.mt-8{margin-top:32px}
textarea, select, input[type=text], input[type=number], input[type=date], input[type=password]{width:100%;padding:10px;background:#0e1218;border:1px solid var(--border);color:#fff;border-radius:10px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
hr{border:none;border-top:1px solid var(--border);margin:16px 0}
table{width:100%;border-collapse:collapse} td,th{border-bottom:1px solid var(--border);padding:8px;text-align:left}
.player{width:100%;height:60vh;border:none;border-radius:22px}
.alert{background:#152031;padding:10px;border-radius:10px;color:#b7c4e6}
footer{color:var(--muted);text-align:center;padding:30px 0}
.hidden{display:none}
.tag{display:inline-block;margin:2px 4px;padding:4px 8px;border:1px solid var(--border);border-radius:999px}
.history-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 12px;
}

.history-item {
  background: var(--card);
  padding: 8px;
  border-radius: 10px;
  font-size: 14px;
  text-align: center;
}

/* üîπ Responsywny odtwarzacz */
.video-container {
  position: relative;
  width: 100%;
  padding-bottom: 56.25%; /* 16:9 proporcja */
  height: 0;
  overflow: hidden;
  background: black;
}
.video-container iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: 0;
}
/* üîπ Overlay do zakrycia g√≥rnego paska MEGA */
.overlay-block {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: black;
  z-index: 2;
}


/* üîπ Pasek overlay 10px */
.top-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 25px;
  background: black;
  z-index: 999999;
}

/* üîπ Napis StreamingHub w prawym g√≥rnym rogu */
.top-brand {
  position: fixed;
  top: 10px;
  right: 12px;
  font-size: 14px;
  font-weight: bold;
  color: white;
  z-index: 1000000;
}


/* Usuniƒôcie bia≈Çej kreski pod czasem i rokiem */
.card .small {
  border: none !important;
}
.card td, 
.card th, 
.card hr {
  border: none !important;
}
</style>

<style type="text/css" id="operaUserStyle"></style></head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="#" onclick="UI.show('home')">üé¨ StreamingHub</a>
    <form onsubmit="event.preventDefault(); UI.search(this.q.value)" style="flex:1;">
      <input type="search" name="q" placeholder="Szukaj film√≥w...">
    </form>
    <nav class="menu flex">
      <a href="#" onclick="UI.show('home')">Filmy</a>
      <a href="#" onclick="UI.show('top')">TOP 10</a>
      <a href="#" onclick="UI.show('me')">Moja biblioteka</a>
      <a href="#" id="adminLink" class="" onclick="UI.show('admin')">Admin</a>
      <span id="authLinks" class="hidden">
        <a href="#" onclick="UI.show('login')">Zaloguj</a>
        <a href="#" onclick="UI.show('register')" class="btn">Rejestracja</a>
      </span>
      <form id="logoutForm" class="" onsubmit="event.preventDefault(); Auth.logout()">
        <button class="btn secondary">Wyloguj</button>
      </form>
    </nav>
  </div>
</header>

<main class="container" id="app">

  <!-- üîπ NOWA SEKCJA: Historia oglƒÖdania -->
  <section class="section mt-8">
    <div class="flex" style="justify-content:space-between;">
      <h2>Historia oglƒÖdania</h2>
      <a href="#" id="toggleHistory" class="small">zobacz wiƒôcej ‚Üí</a>
    </div>
    <div id="historyGrid" class="history-grid"></div>
  </section>

  <!-- üîπ Dalej masz np. Polecane -->
  <section class="section">
    <div class="flex" style="justify-content:space-between">
      <h2>Polecane</h2>
      <a class="small" href="#" onclick="UI.search('', {sort:'rating'})">Najwy≈ºej oceniane ‚Üí</a>
    </div>

    </div></div></section>
      </main>

<footer>¬© <script>document.write(new Date().getFullYear())
// üîπ Funkcja otwierajƒÖca edycjƒô filmu
async function editMovie(index) {
 const { data: movies, error } = await db.from("movies").select("*");
  const movie = movies[index];
  if (!movie) return alert("Film nie istnieje");

  document.getElementById("editIndex").value = index;
  document.getElementById("editTitle").value = movie.title;
  document.getElementById("editIframe").value = movie.iframe;
  document.getElementById("editThumbnail").value = movie.thumbnail;
  document.getElementById("editCategory").value = movie.category || "";
  document.getElementById("editPoints").value = movie.points || 0;

  document.getElementById("editModal").style.display = "block";
}

// üîπ Funkcja zapisujƒÖca edycjƒô filmu
// üîπ Funkcja zapisujƒÖca edycjƒô filmu (Supabase, bez localStorage)
async function saveMovieEdit() {
  try {
    const index = document.getElementById("editIndex").value;
    // pobierz listƒô, ≈ºeby zamieniƒá index -> id
    const { data: movies, error: selErr } = await db.from("movies").select("*").order("id", { ascending: true });
    if (selErr) { console.error(selErr); alert("B≈ÇƒÖd pobierania film√≥w"); return; }
    const movie = movies[Number(index)];
    if (!movie) { alert("Nie znaleziono filmu do edycji"); return; }

    const payload = {
      title: document.getElementById("editTitle").value,
      iframe: document.getElementById("editIframe").value,
      thumb: document.getElementById("editThumbnail").value,
      thumbnail: document.getElementById("editThumbnail").value,
      category_id: document.getElementById("editCategory").value || null,
      category: document.getElementById("editCategory").value || null,
      points_required: parseInt(document.getElementById("editPoints").value) || 0,
      points: parseInt(document.getElementById("editPoints").value) || 0,
      updated_at: new Date().toISOString()
    };

    const { error: upErr } = await db.from("movies").update(payload).eq("id", movie.id);
    if (upErr) { console.error(upErr); alert("B≈ÇƒÖd zapisu do bazy"); return; }

    alert("Film zaktualizowany!");
    document.getElementById("editModal").style.display = "none";
    // od≈õwie≈º listƒô film√≥w na stronie
    if (typeof loadMovies === "function") { loadMovies(); }
  } catch (e) {
    console.error(e);
    alert("WystƒÖpi≈Ç b≈ÇƒÖd przy zapisie");
  }
}
;

</script>2025 StreamingHub ‚Ä¢ version 1.21 </footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   Auth (Supabase profiles)
   ========================= */
const Auth = {
  async current() {
    const { data: { user } } = await db.auth.getUser();
    if (!user) return null;
    const { data: profile } = await db.from("profiles").select("*").eq("id", user.id).single();
    return profile;
  },
  async login(email, pass) {
    const { error } = await db.auth.signInWithPassword({ email, password: pass });
    if (error) {
      console.error(error);
      UI.flash("Z≈Çe dane logowania");
      return;
    }
    UI.flash("Zalogowano ‚úîÔ∏è");
    await UI.updateHeader();
    UI.show('home');
  },
  async register(username, email, pass) {
    const { data, error } = await db.auth.signUp({ email, password: pass, options: { data: { username } } });
    if (error) {
      console.error(error);
      UI.flash("B≈ÇƒÖd rejestracji: " + error.message);
      return;
    }
    if (data.user) {
        const { error: profileError } = await db.from('profiles').insert({ id: data.user.id, username });
        if (profileError) {
            console.error('Error creating profile:', profileError);
            UI.flash("B≈ÇƒÖd tworzenia profilu.");
            return;
        }
    }
    UI.flash("Konto utworzone ‚úîÔ∏è. Sprawd≈∫ email, aby potwierdziƒá rejestracjƒô.");
    await UI.updateHeader();
    UI.show('home');
  },
  async logout() {
    await db.auth.signOut();
    await UI.updateHeader();
    UI.show('home');
  }
};

/* =========================
   Helpers (Supabase)
   ========================= */
async function avgRating(movieId) {
    const { data, error } = await db.from('ratings').select('score').eq('movie_id', movieId);
    if (error || !data || data.length === 0) return null;
    const sum = data.reduce((acc, r) => acc + r.score, 0);
    return (sum / data.length).toFixed(1);
}

async function userCanWatch(user, movie) {
    if (!user) return false;
    if (movie.points_required === 0) return true;
    if (user.premium_until && new Date(user.premium_until) > new Date()) return true;
    const { data, error } = await db.from('unlocks').select().eq('user_id', user.id).eq('movie_id', movie.id).maybeSingle();
    return !!data;
}

function premiumActive(user) {
    if (!user || !user.premium_until) return false;
    return new Date(user.premium_until) > new Date();
}

async function addPoints(userId, amount, reason) {
    const { data: profile, error: profileError } = await db.from('profiles').select('points').eq('id', userId).single();
    if (profileError) return;
    const newPoints = (profile.points || 0) + amount;
    await db.from('profiles').update({ points: newPoints }).eq('id', userId);
    await db.from('points_log').insert({ user_id: userId, change: amount, reason });
}

async function spendPoints(userId, amount, reason) {
    const { data: profile, error: profileError } = await db.from('profiles').select('points').eq('id', userId).single();
    if (profileError || (profile.points || 0) < amount) return false;
    const newPoints = profile.points - amount;
    await db.from('profiles').update({ points: newPoints }).eq('id', userId);
    await db.from('points_log').insert({ user_id: userId, change: -amount, reason });
    return true;
}

async function ensureUnlocked(userId, movieId) {
    const { data } = await db.from('unlocks').select().eq('user_id', userId).eq('movie_id', movieId).maybeSingle();
    if (!data) {
        await db.from('unlocks').insert({ user_id: userId, movie_id: movieId });
    }
}

/* =========================
   UI Rendering
   ========================= */
const UI = {
  el: ()=>document.getElementById('app'),
  state: { view:'home', params:{} },
  flash(msg){
    const div = document.createElement('div');
    div.className = 'alert';
    div.textContent = msg;
    div.style.position='fixed'; div.style.right='16px'; div.style.bottom='16px'; div.style.zIndex='9999';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(),2000);
  },
  async updateHeader() {
    const u = await Auth.current();
    document.getElementById('adminLink').classList.toggle('hidden', !(u && u.is_admin));
    document.getElementById('logoutForm').classList.toggle('hidden', !u);
    document.getElementById('authLinks').classList.toggle('hidden', !!u);
  },
  async show(view, params={}) {
    UI.state.view = view; UI.state.params = params;
    const app = UI.el();
    const user = await Auth.current();

    if (view === 'home') {
        const { data: featured } = await db.from('movies').select('*').order('points_required', { ascending: false }).limit(12);
        const { data: newest } = await db.from('movies').select('*').order('created_at', { ascending: false }).limit(12);
        
        app.innerHTML = `
            <section class="section">
                <div class="flex" style="justify-content:space-between">
                    <h2>Polecane</h2>
                    <a class="small" href="#" onclick="UI.search('', {sort:'rating'})">Najwy≈ºej oceniane ‚Üí</a>
                </div>
                <div class="grid">${(featured || []).map(UI.card).join('')}</div>
            </section>
            <section class="section">
                <h2>Nowo dodane</h2>
                <div class="grid">${(newest || []).map(UI.card).join('')}</div>
            </section>
        `;
    }
    else if(view==='movie'){
      const { data: m, error } = await db.from('movies').select('*, categories(name)').eq('id', params.id).single();
      if (error || !m) { app.innerHTML = "<div class='alert'>Nie znaleziono filmu.</div>"; return; }

      const { data: comm } = await db.from('comments').select('*, profiles(username)').eq('movie_id', m.id).order('created_at', { ascending: false });
      const rAvg = await avgRating(m.id) || '-';
      const youRated = user ? (await db.from('ratings').select('score').eq('user_id', user.id).eq('movie_id', m.id).single()).data : null;
      const canWatch = await userCanWatch(user, m);

      app.innerHTML = `
        <div class="flex" style="justify-content:space-between;">
          <div>
            <h1>${m.title}</h1>
            <div class="small">Rok: ${m.year||'?'} ‚Ä¢ D≈Çugo≈õƒá: ${m.length_min||'?'} min ‚Ä¢ Kategoria: ${m.categories?.name || '?'}</div>
            ${m.points_required ? `<div class="mt-2 alert">Wymagane punkty do odblokowania: <strong>${m.points_required}</strong></div>` : ''}
          </div>
          <div class="flex">${user? `<button class="btn secondary" onclick="UI.toggleWishlist(${m.id})">Chcƒô obejrzeƒá</button>`:''}</div>
        </div>
        <img class="mt-4" src="${m.thumb}" style="width:100%;max-height:360px;object-fit:cover;border-radius:14px">
        <div class="mt-4"><p>${m.description||'Brak opisu.'}</p></div>
        <div class="mt-4">
          ${user ? (canWatch ? `<a class="btn" href="#" onclick="UI.show('watch',{id:${m.id}})">OglƒÖdaj</a>` :
            `<button class="btn" onclick="UI.unlock(${m.id})">Odblokuj za punkty</button><div class="small mt-2">Masz: ${user.points||0} pkt</div>`) :
            `<a class="btn" href="#" onclick="UI.show('login')">Zaloguj, aby oglƒÖdaƒá</a>`}
        </div>
        <hr class="mt-8">
        <section class="mt-4">
          <h3>Oceny</h3>
          <div class="flex">
            <div>≈örednia: <strong>${rAvg}</strong>/10</div>
            ${user ? `
              <form class="flex" onsubmit="event.preventDefault(); UI.rate(${m.id}, this.score.value)">
                <select name="score">${Array.from({length:10},(_,i)=>i+1).map(i=>`<option value="${i+1}" ${youRated&&youRated.score===(i+1)?'selected':''}>${i+1}</option>`).join('')}</select>
                <button class="btn secondary">Oce≈Ñ</button>
              </form>` : ''}
          </div>
        </section>
        <section class="mt-4">
          <h3>Komentarze</h3>
          ${user ? `
            <form onsubmit="event.preventDefault(); UI.comment(${m.id}, this.text.value); this.reset();">
              <textarea name="text" rows="3" placeholder="Napisz komentarz..."></textarea>
              <button class="btn mt-2">Dodaj</button>
            </form>` : `<div class="alert">Zaloguj siƒô, aby dodaƒá komentarz.</div>`}
          <div class="mt-4">
            ${(comm || []).map(c=>`
              <div class="card p mt-2">
                <div class="small"><strong>${c.profiles?.username||"?"}</strong> ‚Ä¢ ${new Date(c.created_at).toLocaleString()}</div>
                <div class="mt-2">${escapeHtml(c.text)}</div>
              </div>`).join('')}
          </div>
        </section>
      `;
    }
    else if(view==='watch'){
      const { data: m } = await db.from('movies').select('*').eq('id', params.id).single();
      if(!m){ app.innerHTML = "<div class='alert'>Nie znaleziono filmu.</div>"; return; }
      if(!await userCanWatch(user, m)){ UI.show('movie',{id:m.id}); return; }
      await ensureUnlocked(user.id, m.id);
      // Add to history
      const { data: existing } = await db.from("history").select("id").eq("user_id", user.id).eq("movie_id", m.id).single();
      if (existing) {
        await db.from("history").update({ watched_at: new Date().toISOString() }).eq("id", existing.id);
      } else {
        await db.from("history").insert({ user_id: user.id, movie_id: m.id, watched_at: new Date().toISOString() });
      }

      app.innerHTML = `
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h1>Odtwarzacz: ${m.title}</h1>
          <a class="btn secondary" href="#" onclick="UI.show('movie',{id:${m.id}})">‚Üê Powr√≥t</a>
        </div>
        <div class="video-container"><iframe class="player mt-4" src="${m.iframe}" allowfullscreen></iframe><div class="overlay-block"></div></div>
        <div class="small mt-2">Jako≈õƒá, g≈Ço≈õno≈õƒá i prƒôdko≈õƒá sƒÖ po stronie hostingu iframe. Tryb nocny: u≈ºyj motywu systemu.</div>
      `;
    }
    else if(view==='login'){
      app.innerHTML = `
        <h1>Logowanie</h1>
        <form class="mt-4" onsubmit="event.preventDefault(); Auth.login(this.email.value, this.password.value)">
          <label>Email</label><input required type="email" name="email">
          <label>Has≈Ço</label><input required type="password" name="password">
          <button class="btn mt-4">Zaloguj</button>
        </form>
        <p class="small mt-2">Nie masz konta? <a href="#" onclick="UI.show('register')">Zarejestruj siƒô</a></p>
      `;
    }
    else if(view==='register'){
      app.innerHTML = `
        <h1>Rejestracja</h1>
        <form class="mt-4" onsubmit="event.preventDefault(); Auth.register(this.username.value, this.email.value, this.password.value)">
          <label>Nick</label><input required type="text" name="username">
          <label>Email</label><input required type="email" name="email">
          <label>Has≈Ço (min 6 znak√≥w)</label><input required type="password" name="password" minlength="6">
          <button class="btn mt-4">Utw√≥rz konto</button>
        </form>
      `;
    }
    else if(view==='me'){
      if(!user){ UI.show('login'); return; }
      const { data: hist } = await db.from('history').select('*, movies(*)').eq('user_id', user.id).order('watched_at', { ascending: false }).limit(100);
      const { data: wish } = await db.from('wishlist').select('*, movies(*)').eq('user_id', user.id);
      
      app.innerHTML = `
        <h1>M√≥j profil</h1>
        <div class="grid" style="grid-template-columns:2fr 1fr;gap:16px">
          <div class="card p">
            <h3>Profil</h3>
            <p><strong>${user.username}</strong></p>
            <p>Punkty: <strong>${user.points||0}</strong> ${user.premium_until?` ‚Ä¢ Premium do: ${new Date(user.premium_until).toLocaleDateString()}`:''}</p>
            <form onsubmit="event.preventDefault(); UI.saveBio(this.bio.value)">
              <label>Opis</label>
              <textarea name="bio" rows="3">${user.bio||''}</textarea>
              <button class="btn mt-2">Zapisz</button>
            </form>
            <div class="mt-4">
              <button class="btn" onclick="UI.earnAd()">+50 pkt za reklamƒô</button> <span class="small">(demo)</span>
              <form class="flex mt-2" onsubmit="event.preventDefault(); UI.redeem(this.code.value)">
                <input type="text" name="code" placeholder="Kod premium/punkty">
                <button class="btn secondary">U≈ºyj kodu</button>
              </form>
            </div>
          </div>
          <div class="card p">
            <h3>Znajomi</h3>
            <div class="small">Funkcja wkr√≥tce.</div>
          </div>
        </div>
        <div class="mt-4">
          <h3>Historia oglƒÖdania</h3>
          <div class="grid">${(hist || []).map(h => UI.card(h.movies)).join('')}</div>
        </div>
        <div class="mt-4">
          <h3>Lista ‚ÄûChcƒô obejrzeƒá‚Äù</h3>
          <div class="grid">${(wish || []).map(w => UI.card(w.movies)).join('')}</div>
        </div>
      `;
    }
    else if(view==='top'){
        app.innerHTML = `<h1>Ranking punkt√≥w</h1><p>Funkcja wkr√≥tce.</p>`;
    }
    else if(view==='admin'){
      if(!(user && user.is_admin)){ app.innerHTML = "<div class='alert'>Brak dostƒôpu.</div>"; return; }
      app.innerHTML = await UI.adminPanel();
    }
    else if(view==='search'){
      const q = params.q?.trim().toLowerCase() || '';
      const { cat, year, len, sort } = params;
      
      let query = db.from('movies').select('*');
      if (q) query = query.ilike('title', `%${q}%`);
      if (cat) query = query.eq('category_id', cat);
      if (year) query = query.eq('year', year);
      if (len) query = query.gte('length_min', len);
      // sortowanie wymaga≈Çoby bardziej z≈Ço≈ºonego zapytania, na razie pomijam
      
      const { data: res } = await query;

      app.innerHTML = await UI.filters(params) + `<h3 class="mt-4">Wyniki</h3><div class="grid">${(res || []).map(UI.card).join('') || '<div class="small">Brak wynik√≥w.</div>'}</div>`;
    }
  },
  async filters(params={}){
    const { data: categories } = await db.from('categories').select('*');
    const p = Object.assign({ cat:'', year:'', len:'', sort:'rating', q:'' }, params||{});
    return `
    <section class="section mt-8">
      <h2>Filtruj</h2>
      <form class="form" onsubmit="event.preventDefault(); UI.search(this.q.value, {cat:this.cat.value, year:this.year.value, len:this.len.value, sort:this.sort.value})">
        <div class="form-row">
          <div><label>Kategoria</label>
            <select name="cat"><option value="">‚Äî</option>${(categories || []).map(c=>`<option value="${c.id}" ${p.cat==c.id?'selected':''}>${c.name}</option>`).join('')}</select>
          </div>
          <div><label>Rok</label><input type="number" name="year" value="${p.year||''}"></div>
        </div>
        <div class="form-row">
          <div><label>Min. d≈Çugo≈õƒá (min)</label><input type="number" name="len" value="${p.len||''}"></div>
          <div><label>Sortowanie</label>
            <select name="sort">
              <option value="rating" ${p.sort==='rating'?'selected':''}>Ocena</option>
              <option value="new" ${p.sort==='new'?'selected':''}>Najnowsze</option>
            </select>
          </div>
        </div>
        <label>Szukaj</label><input type="text" name="q" value="${p.q||''}" placeholder="Tytu≈Ç...">
        <button class="btn mt-4">Szukaj</button>
      </form>
    </section>`;
  },
  search(q, extra={}){ UI.show('search', { q, ...extra }); },
  card(m){
    if(!m) return '';
    // avgRating jest async, wiƒôc to wymaga≈Çoby zmian w renderowaniu
    return `<div class="card">
      <a href="#" onclick="UI.show('movie',{id:${m.id}})"><img src="${m.thumb}" alt="${escapeHtml(m.title)}"></a>
      <div class="card p">
        <div class="flex" style="justify-content:space-between;">
          <strong><a href="#" onclick="UI.show('movie',{id:${m.id}})">${escapeHtml(m.title)}</a></strong>
          <!-- <span class="badge">‚òÖ ${ar?ar:'-'}</span> -->
        </div>
        <div class="small mt-2">czas: ${m.length_min||'?'} min ‚Ä¢ rok: ${m.year||'?'}</div>
      </div>
    </div>`;
  },
  async toggleWishlist(movieId){
    const user = await Auth.current(); if(!user) return;
    const { data: ex } = await db.from('wishlist').select('id').eq('user_id', user.id).eq('movie_id', movieId).single();
    if(ex) {
        await db.from('wishlist').delete().eq('id', ex.id);
    } else {
        await db.from('wishlist').insert({ user_id: user.id, movie_id: movieId });
    }
    UI.flash("Zaktualizowano listƒô.");
  },
  async unlock(movieId){
    const user = await Auth.current(); 
    const { data: m } = await db.from('movies').select('*').eq('id', movieId).single();
    if(!user) return UI.show('login');
    if(await userCanWatch(user,m)) return UI.show('watch',{id:m.id});
    if(!m.points_required) return UI.show('watch',{id:m.id});
    if(!await spendPoints(user.id, m.points_required, `Odblokowanie: ${m.title}`)) return UI.flash("Za ma≈Ço punkt√≥w");
    await ensureUnlocked(user.id, m.id);
    UI.flash("Odblokowano ‚úîÔ∏è");
    UI.show('watch',{id:m.id});
  },
  async rate(movieId, score){
    const user = await Auth.current(); if(!user) return;
    score = Number(score);
    await db.from('ratings').upsert({ user_id: user.id, movie_id: movieId, score });
    UI.flash("Dziƒôkujemy za ocenƒô!");
    UI.show('movie',{id:movieId});
  },
  async comment(movieId, text){
    const user = await Auth.current(); if(!user) return;
    text = (text||'').trim(); if(!text) return;
    await db.from('comments').insert({ movie_id: movieId, user_id: user.id, text: text.slice(0,2000) });
    UI.show('movie',{id:movieId});
  },
  
async saveBio(bio){
    const user = await Auth.current(); if(!user) return;
    await db.from('profiles').update({ bio: (bio||'').slice(0,300) }).eq('id', user.id);
    UI.flash("Zapisano ‚úîÔ∏è");
    UI.show('me');
  },
  async earnAd(){
    const user = await Auth.current(); if(!user) return UI.show('login');
    let gain = 50;
    if(premiumActive(user)) gain *= 2;
    await addPoints(user.id, gain, "OglƒÖdniƒôcie reklamy (demo)");
    UI.flash(`Zdobyto ${gain} pkt`);
    UI.show('me');
  },
  async redeem(codeStr){
    const user = await Auth.current(); if(!user) return UI.show('login');
    const { data: c } = await db.from('codes').select('*').eq('code', String(codeStr||'').trim().toUpperCase()).single();
    
    if(!c) { UI.flash("Nieprawid≈Çowy kod"); return; }
    if(c.limit_left<=0) { UI.flash("Wyczerpany limit u≈ºyƒá"); return; }
    if(c.expires && new Date(c.expires) < new Date()){ UI.flash("Kod wygas≈Ç"); return; }

    if(c.type==='points'){
      await addPoints(user.id, c.amount, `Kod: ${c.code}`);
    } else if(c.type==='premium'){
      const days = Number(c.days||c.amount||7);
      const base = user.premium_until ? new Date(user.premium_until) : new Date();
      const start = base > new Date() ? base : new Date();
      const until = new Date(start.getTime() + days*24*60*60*1000);
      await db.from('profiles').update({ premium_until: until.toISOString() }).eq('id', user.id);
    }
    await db.from('codes').update({ limit_left: c.limit_left - 1 }).eq('code', c.code);
    UI.flash("Kod zrealizowany ‚úîÔ∏è");
    UI.show('me');
  },
  async adminPanel(){
    const { data: movies } = await db.from('movies').select('*');
    const { data: codes } = await db.from('codes').select('*');
    const { data: categories } = await db.from('categories').select('*');

    const moviesRows = (movies || []).map(m=>`
      <tr>
        <td><a href="#" onclick="UI.show('movie',{id:${m.id}})">${escapeHtml(m.title)}</a></td>
        <td>${m.points_required||0}</td>
        <td><button class="btn secondary" onclick="UI.deleteMovie(${m.id})">Usu≈Ñ</button></td>
      </tr>`).join('');
    const codesRows = (codes || []).map(c=>`
      <tr><td>${c.code}</td><td>${c.type}</td><td>${c.amount}</td><td>${c.limit_left}</td><td>${c.expires||'-'}</td></tr>`).join('');
    return `
      <h1>Panel admina</h1>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
        <div class="card p">
          <h3>Dodaj film</h3>
          <form onsubmit="event.preventDefault(); UI.addMovie(this)">
            <label>Tytu≈Ç</label><input name="title" required>
            <label>Opis</label><textarea name="description"></textarea>
            <label>Link miniatury (URL)</label><input name="thumb" required>
            <label>Iframe src (URL hostingu)</label><input name="iframe" required placeholder="https://...">
            <div class="form-row">
              <div>
                <label>Kategoria</label>
                <select name="categoryId">
                  ${(categories || []).map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}
                </select>
              </div>
              <div><label>Rok</label><input type="number" name="year"></div>
            </div>
            <div class="form-row">
              <div><label>D≈Çugo≈õƒá (min)</label><input type="number" name="lengthMin"></div>
              <div><label>Punkty wymagane</label><input type="number" name="pointsRequired" value="0"></div>
            </div>
            <button class="btn mt-2">Dodaj</button>
          </form>
        </div>
        <div class="card p">
          <h3>Kategorie</h3>
          <form class="flex" onsubmit="event.preventDefault(); UI.addCategory(this.name.value); this.reset();">
            <input name="name" placeholder="Nazwa kategorii">
            <button class="btn secondary">Dodaj</button>
          </form>
          <div class="mt-2">${(categories || []).map(c=>`<span class="tag">${c.name} <a href="#" onclick="UI.delCategory(${c.id})">√ó</a></span>`).join('')}</div>
        </div>
        <div class="card p">
          <h3>Kody (punkty/premium)</h3>
          <form onsubmit="event.preventDefault(); UI.addCode(this)">
            <div class="form-row">
              <div>
                <label>Typ</label>
                <select name="type"><option value="points">punkty</option><option value="premium">premium</option></select>
              </div>
              <div><label>Ilo≈õƒá punkt√≥w / dni premium</label><input type="number" name="amount" required></div>
            </div>
            <div class="form-row">
              <div><label>Limit u≈ºyƒá</label><input type="number" name="limitLeft" value="100"></div>
              <div><label>Dni premium (opcjonalnie)</label><input type="number" name="days"></div>
            </div>
            <label>Data wa≈ºno≈õci (opcjonalnie)</label><input type="date" name="expires">
            <button class="btn mt-2">Utw√≥rz kod</button>
          </form>
          <table class="mt-2"><tr><th>Kod</th><th>Typ</th><th>Amount</th><th>Pozosta≈Ço</th><th>Wygasa</th></tr>${codesRows}</table>
        </div>
        <div class="card p">
          <h3>Lista film√≥w</h3>
          <table><tr><th>Tytu≈Ç</th><th>Punkty</th><th></th></tr>${moviesRows}</table>
        </div>
      </div>
    `;
  },
  async addMovie(form){
    const { error } = await db.from('movies').insert({
      title: form.title.value.trim(),
      description: form.description.value.trim(),
      thumb: form.thumb.value.trim(),
      iframe: form.iframe.value.trim(),
      category_id: Number(form.categoryId.value),
      year: form.year.value? Number(form.year.value) : null,
      length_min: form.lengthMin.value? Number(form.lengthMin.value) : null,
      points_required: form.pointsRequired.value? Number(form.pointsRequired.value) : 0,
    });
    if (error) {
      console.error("B≈ÇƒÖd dodawania filmu:", error);
      return UI.flash(`B≈ÇƒÖd: ${error.message}`);
    }
    UI.flash("Film dodany ‚úîÔ∏è"); UI.show('admin');
  },
  
async deleteMovie(id){
  // RLS powinien zajƒÖƒá siƒô kaskadowym usuwaniem, je≈õli jest skonfigurowany.
  // Je≈õli nie, trzeba usuwaƒá rƒôcznie z ka≈ºdej tabeli.
  await db.from('movies').delete().eq('id', id);
  UI.flash("Film usuniƒôty.");
  UI.show('admin');
}
,
  async addCategory(name){
    name = (name||'').trim(); if(!name) return;
    const { error } = await db.from('categories').insert({ name });
    if (error) {
      console.error("B≈ÇƒÖd dodawania kategorii:", error);
      return UI.flash(`B≈ÇƒÖd: ${error.message}`);
    }
    UI.show('admin');
  },
  async delCategory(id){
    await db.from('categories').delete().eq('id', id);
    UI.show('admin');
  },
  async addCode(form){
    const code = Math.random().toString(36).slice(2,12).toUpperCase();
    const type = form.type.value;
    const amount = Number(form.amount.value);
    const limit_left = Number(form.limitLeft.value||1);
    const days = form.days.value? Number(form.days.value) : null;
    const expires = form.expires.value || null;
    const { error } = await db.from('codes').insert({ code, type, amount, limit_left, days, expires });
    if (error) {
      console.error("B≈ÇƒÖd dodawania kodu:", error);
      return UI.flash(`B≈ÇƒÖd: ${error.message}`);
    }
    UI.flash(`Utworzono kod: ${code}`); UI.show('admin');
  }
};

function escapeHtml(str){
  return (str||'').replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[s]));
}

// initial render
document.addEventListener('DOMContentLoaded', () => {
    UI.updateHeader();
    UI.show('home');
    // renderHistory(); // Historia jest teraz czƒô≈õciƒÖ widoku 'me'
});

db.auth.onAuthStateChange((event, session) => {
    UI.updateHeader();
    if (event === 'SIGNED_IN') {
        UI.show('home');
    }
    if (event === 'SIGNED_OUT') {
        UI.show('home');
    }
});
</script>

</body>
</html>